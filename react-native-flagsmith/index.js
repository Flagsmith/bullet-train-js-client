!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["react-native-flagsmith"]={})}(this,(function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},e.apply(this,arguments)};function i(t,e,i){if(i||2===arguments.length)for(var n,a=0,r=e.length;a<r;a++)!n&&a in e||(n||(n=Array.prototype.slice.call(e,0,a)),n[a]=e[a]);return t.concat(n||Array.prototype.slice.call(e))}var n,a,r=function t(e,i){if(e===i)return!0;if(e&&i&&"object"==typeof e&&"object"==typeof i){if(e.constructor!==i.constructor)return!1;var n,a,r;if(Array.isArray(e)){if((n=e.length)!=i.length)return!1;for(a=n;0!=a--;)if(!t(e[a],i[a]))return!1;return!0}if(e.constructor===RegExp)return e.source===i.source&&e.flags===i.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===i.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===i.toString();if((n=(r=Object.keys(e)).length)!==Object.keys(i).length)return!1;for(a=n;0!=a--;)if(!Object.prototype.hasOwnProperty.call(i,r[a]))return!1;for(a=n;0!=a--;){var s=r[a];if(!t(e[s],i[s]))return!1}return!0}return e!=e&&i!=i},s=void 0!==s?s:"undefined"!=typeof window?window:{},o="BULLET_TRAIN_DB",l="BULLET_TRAIN_EVENT",g="https://edge.api.flagsmith.com/api/v1/",c=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},u=function(){function t(t){var i=this;this.getJSON=function(t,e,a){var r=i,s=r.environmentID,o=r.headers,l={method:e||"GET",body:a,headers:{"x-environment-key":s}};return e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),n(t,l).then((function(t){return t.text().then((function(e){var i=e;try{i=JSON.parse(e)}catch(t){}return t.ok?i:Promise.reject(i)}))}))},this.getFlags=function(t,n){var a=i,s=a.onChange,o=a.onError,l=a.identity,g=a.api,c=!1;i.log("Get Flags");var u=function(t){var n=t.flags,a=t.traits;l&&(i.withTraits=!1);var o={},g={};a=a||[],(n=n||[]).forEach((function(t){o[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),a.forEach((function(t){g[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),i.oldFlags=e({},i.flags);var c=r(i.flags,o),u=r(i.traits,g);if(i.flags=o,i.traits=g,i.updateStorage(),i.dtrum){var h={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(i.flags).map((function(t){f(h,"flagsmith_value_"+t,i.getValue(t)),f(h,"flagsmith_enabled_"+t,i.hasFeature(t))})),Object.keys(i.traits).map((function(t){f(h,"flagsmith_trait_"+t,i.getTrait(t))})),i.log("Sending javaLongOrObject traits to dynatrace",h.javaLongOrObject),i.log("Sending date traits to dynatrace",h.date),i.log("Sending shortString traits to dynatrace",h.shortString),i.log("Sending javaDouble to dynatrace",h.javaDouble),i.dtrum.sendSessionProperties(h.javaLongOrObject,h.date,h.shortString,h.javaDouble)}i.trigger&&i.trigger(),s&&s(i.oldFlags,{isFromServer:!0,flagsChanged:!c,traitsChanged:!u})};return l?Promise.all([i.withTraits?i.getJSON(g+"identities/","POST",JSON.stringify({identifier:l,traits:Object.keys(i.withTraits).map((function(t){return{trait_key:t,trait_value:i.withTraits[t]}}))})):i.getJSON(g+"identities/?identifier="+encodeURIComponent(l))]).then((function(e){i.withTraits=!1,u(e[0]),t&&!c&&(c=!0,t())})).catch((function(t){var e=t.message;o&&o({message:e})})):Promise.all([i.getJSON(g+"flags/")]).then((function(e){u({flags:e[0]}),t&&!c&&(c=!0,t())})).catch((function(t){n&&!c&&(c=!0,n(t)),o&&o(t)}))},this.analyticsFlags=function(){var t=i.api;if(0!==Object.getOwnPropertyNames(i.evaluationEvent).length)return i.getJSON(t+"analytics/flags/","POST",JSON.stringify(i.evaluationEvent)).then((function(t){var n=i.getState();i.setState(e(e({},n),{evaluationEvent:{}})),i.updateEventStorage()})).catch((function(t){i.log("Exception fetching evaluationEvent",t)}))},this.analyticsInterval=null,this.api=null,this.cacheFlags=null,this.ts=null,this.enableAnalytics=null,this.enableLogs=null,this.environmentID=null,this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=null,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(i.enableAnalytics){if(!i.evaluationEvent)return;void 0===i.evaluationEvent[t]&&(i.evaluationEvent[t]=0),i.evaluationEvent[t]+=1}i.updateEventStorage()},this.getValue=function(t){var e=i.flags&&i.flags[t.toLowerCase().replace(/ /g,"_")],n=null;return e&&(n=e.value),i.evaluateFlag(t),n},this.getTrait=function(t){return i.traits&&i.traits[t.toLowerCase().replace(/ /g,"_")]},this.setTrait=function(t,n){var a=i,r=a.getJSON,s=a.identity,o=a.api;if(o){var l={};if(l[t]=n,!i.identity)return i.withTraits=e(e({},i.withTraits||{}),l),void i.log("Set trait prior to identifying",i.withTraits);var g={identity:{identifier:s},trait_key:t,trait_value:n};return r("".concat(o,"traits/"),"POST",JSON.stringify(g)).then((function(){i.initialised&&i.getFlags()}))}console.error(c("setTrait"))},this.setTraits=function(t){var n=i;n.getJSON;var a=n.identity,r=n.api;if(r)return t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),i.identity?i.getJSON(r+"identities/","POST",JSON.stringify({identifier:a,traits:Object.keys(t).map((function(e){return{trait_key:e,trait_value:t[e]}}))})).then((function(){i.initialised&&i.getFlags()})):(i.withTraits=e(e({},i.withTraits||{}),t),void i.log("Set traits prior to identifying",i.withTraits));console.error(c("setTraits"))},this.hasFeature=function(t){var e=i.flags&&i.flags[t.toLowerCase().replace(/ /g,"_")],n=!1;return e&&e.enabled&&(n=!0),i.evaluateFlag(t),n},n=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:s.fetch,a=t.AsyncStorage}return t.prototype.init=function(t){var i=this,r=t.environmentID,s=t.api,c=void 0===s?g:s,u=t.headers,h=t.onChange,f=t.cacheFlags,v=t.onError,p=t.defaultFlags,d=t.preventFetch,y=t.enableLogs,m=t.enableDynatrace,O=t.enableAnalytics,S=t.AsyncStorage,b=t.identity,I=t.traits,w=t._trigger,F=t.state,E=t.cacheOptions,T=t.angularHttpClient;return new Promise((function(t,s){if(i.environmentID=r,i.api=c,i.headers=u,i.getFlagInterval=null,i.analyticsInterval=null,i.onChange=h,i.trigger=w,i.onError=v,i.identity=b,i.withTraits=I,i.enableLogs=y,i.cacheOptions=E?{skipAPI:!!E.skipAPI,ttl:E.ttl||0}:i.cacheOptions,!i.cacheOptions.ttl&&i.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),i.enableAnalytics=O||!1,i.flags=Object.assign({},p)||{},i.initialised=!0,i.ticks=1e4,i.log("Initialising with properties",{environmentID:r,api:c,headers:u,onChange:h,cacheFlags:f,onError:v,defaultFlags:p,preventFetch:d,enableLogs:y,enableAnalytics:O,AsyncStorage:a,identity:b,traits:I,_trigger:w,state:F,angularHttpClient:T},i),i.timer=i.enableLogs?(new Date).valueOf():null,S&&(a=S),i.cacheFlags=void 0!==a&&f,i.setState(F),!r)throw s("Please specify a environment id"),"Please specify a environment id";m&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):i.dtrum=dtrum),T&&(n=function(t,e){var i=e.headers,n=e.method,a=e.body;return new Promise((function(e){switch(n){case"GET":return T.get(t,{headers:i}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return T.post(t,a,{headers:i}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}))}}))}),a&&"undefined"!=typeof window&&a.getItem(l).then((function(t){if(t)try{i.evaluationEvent=JSON.parse(t)}catch(t){i.evaluationEvent={}}else i.evaluationEvent={};return i.analyticsInterval=setInterval(i.analyticsFlags,i.ticks),!0})),i.enableAnalytics&&(i.analyticsInterval&&clearInterval(i.analyticsInterval),a&&"undefined"!=typeof window&&a.getItem(l,(function(t,n){if(n){var a=JSON.parse(n);a&&(F=i.getState(),i.log("Retrieved events from cache",n),i.setState(e(e({},F),{evaluationEvent:a})))}return!0}))),f?a&&"undefined"!=typeof window&&a.getItem(o,(function(e,n){if(n)try{var a=JSON.parse(n),r=!1;if(a&&a.api===i.api&&a.environmentID===i.environmentID){var o=!0;i.cacheOptions.ttl&&(!a.ts||(new Date).valueOf()-a.ts>i.cacheOptions.ttl)&&a.ts&&(i.log("Ignoring cache, timestamp is too old ts:"+a.ts+" ttl: "+i.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-a.ts)+"ms"),o=!1),o&&(r=!0,i.setState(a),i.log("Retrieved flags from cache",a))}i.flags?(i.trigger&&i.trigger(),i.onChange&&i.onChange(null,{isFromServer:!1}),i.oldFlags=i.flags,t(!0),i.cacheOptions.skipAPI&&r&&i.log("Skipping API, using cache"),d||i.cacheOptions.skipAPI&&r||i.getFlags()):d?t(!0):i.getFlags(t,s)}catch(t){i.log("Exception fetching cached logs",t)}else d?(p&&(i.trigger&&i.trigger(),i.onChange&&i.onChange(null,{isFromServer:!1})),t(!0)):i.getFlags(t,s);return!0})):d?(p&&(i.trigger&&i.trigger(),i.onChange&&i.onChange(null,{isFromServer:!1})),t(!0)):i.getFlags(t,s)})).catch((function(t){return v&&v(t)}))},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,i){return this.identity=t,this.log("Identify: "+this.identity),i&&(this.withTraits=e(e({},this.withTraits||{}),i)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||g,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent)},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,i(["FLAGSMITH:",(new Date).valueOf()-this.timer,"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),a.setItem(o,t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),a.setItem(l,t)}},t.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){clearInterval(this.getFlagInterval),this.getFlagInterval=null},t.prototype.getSegments=function(){},t}();function h(t){var e=t.fetch,i=t.AsyncStorage;return new u({fetch:e,AsyncStorage:i})}var f=function(t,e,i){var n="shortString",a=!0;"number"==typeof i&&(n="javaDouble",a=!1),t[n]=t[n]||{},t[n][e]=a?i+"":i},v=h({});t.createFlagsmithInstance=()=>h({}),t.default=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
