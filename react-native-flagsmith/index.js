!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["react-native-flagsmith"]={})}(this,(function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},e.apply(this,arguments)};function i(t,e,i){if(i||2===arguments.length)for(var n,s=0,a=e.length;s<a;s++)!n&&s in e||(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return t.concat(n||Array.prototype.slice.call(e))}function n(t){if(t.__esModule)return t;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(t).forEach((function(i){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})})),e}var s,a,r,o=function t(e,i){if(e===i)return!0;if(e&&i&&"object"==typeof e&&"object"==typeof i){if(e.constructor!==i.constructor)return!1;var n,s,a;if(Array.isArray(e)){if((n=e.length)!=i.length)return!1;for(s=n;0!=s--;)if(!t(e[s],i[s]))return!1;return!0}if(e.constructor===RegExp)return e.source===i.source&&e.flags===i.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===i.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===i.toString();if((n=(a=Object.keys(e)).length)!==Object.keys(i).length)return!1;for(s=n;0!=s--;)if(!Object.prototype.hasOwnProperty.call(i,a[s]))return!1;for(s=n;0!=s--;){var r=a[s];if(!t(e[r],i[r]))return!1}return!0}return e!=e&&i!=i},l=void 0!==l?l:"undefined"!=typeof window?window:{},h="BULLET_TRAIN_DB",u="BULLET_TRAIN_EVENT",c="https://edge.api.flagsmith.com/api/v1/",g=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},d=function(){function t(t){var i=this;this.eventSource=null,this.getJSON=function(t,e,n){var a=i,r=a.environmentID,o=a.headers,l={method:e||"GET",body:n,headers:{"x-environment-key":r}};return e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),s||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR."),s(t,l).then((function(n){return i.log("Fetch response: "+n.status+" "+(e||"GET")+0+t),n.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return n.ok?e:Promise.reject(e)}))})).catch((function(t){console.error("Flagsmith: Fetch error: "+t)}))},this.getFlags=function(t,n){var s=i,a=s.onChange,r=s.onError,l=s.identity,h=s.api,u=!1;i.log("Get Flags");var c=function(t){var n=t.flags,s=t.traits;l&&(i.withTraits=!1);var r={},h={};s=s||[],(n=n||[]).forEach((function(t){r[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),s.forEach((function(t){h[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),i.oldFlags=e({},i.flags);var u=o(i.flags,r),c=o(i.traits,h);if(i.flags=r,i.traits=h,i.updateStorage(),i.dtrum){var g={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(i.flags).map((function(t){v(g,"flagsmith_value_"+t,i.getValue(t)),v(g,"flagsmith_enabled_"+t,i.hasFeature(t))})),Object.keys(i.traits).map((function(t){v(g,"flagsmith_trait_"+t,i.getTrait(t))})),i.log("Sending javaLongOrObject traits to dynatrace",g.javaLongOrObject),i.log("Sending date traits to dynatrace",g.date),i.log("Sending shortString traits to dynatrace",g.shortString),i.log("Sending javaDouble to dynatrace",g.javaDouble),i.dtrum.sendSessionProperties(g.javaLongOrObject,g.date,g.shortString,g.javaDouble)}i.trigger&&i.trigger(),a&&a(i.oldFlags,{isFromServer:!0,flagsChanged:!u,traitsChanged:!c})};return l?Promise.all([i.withTraits?i.getJSON(h+"identities/","POST",JSON.stringify({identifier:l,traits:Object.keys(i.withTraits).map((function(t){return{trait_key:t,trait_value:i.withTraits[t]}}))})):i.getJSON(h+"identities/?identifier="+encodeURIComponent(l))]).then((function(e){i.withTraits=!1,c(e[0]),t&&!u&&(u=!0,t())})).catch((function(t){var e=t.message;r&&r({message:e})})):Promise.all([i.getJSON(h+"flags/")]).then((function(e){c({flags:e[0],traits:null}),t&&!u&&(u=!0,t())})).catch((function(t){n&&!u&&(u=!0,n(t)),r&&r(t)}))},this.analyticsFlags=function(){var t=i.api;if(0!==Object.getOwnPropertyNames(i.evaluationEvent).length)return i.getJSON(t+"analytics/flags/","POST",JSON.stringify(i.evaluationEvent)).then((function(t){var n=i.getState();i.setState(e(e({},n),{evaluationEvent:{}})),i.updateEventStorage()})).catch((function(t){i.log("Exception fetching evaluationEvent",t)}))},this.analyticsInterval=null,this.api=null,this.cacheFlags=null,this.ts=null,this.enableAnalytics=null,this.enableLogs=null,this.environmentID=null,this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=null,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(i.enableAnalytics){if(!i.evaluationEvent)return;void 0===i.evaluationEvent[t]&&(i.evaluationEvent[t]=0),i.evaluationEvent[t]+=1}i.updateEventStorage()},this.getValue=function(t){var e=i.flags&&i.flags[t.toLowerCase().replace(/ /g,"_")],n=null;return e&&(n=e.value),i.evaluateFlag(t),n},this.getTrait=function(t){return i.traits&&i.traits[t.toLowerCase().replace(/ /g,"_")]},this.setTrait=function(t,n){var s=i,a=s.getJSON,r=s.identity,o=s.api;if(o){var l={};if(l[t]=n,!i.identity)return i.withTraits=e(e({},i.withTraits||{}),l),void i.log("Set trait prior to identifying",i.withTraits);var h={identity:{identifier:r},trait_key:t,trait_value:n};return a("".concat(o,"traits/"),"POST",JSON.stringify(h)).then((function(){i.initialised&&i.getFlags()}))}console.error(g("setTrait"))},this.setTraits=function(t){var n=i;n.getJSON;var s=n.identity,a=n.api;if(a)return t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),i.identity?i.getJSON(a+"identities/","POST",JSON.stringify({identifier:s,traits:Object.keys(t).map((function(e){return{trait_key:e,trait_value:t[e]}}))})).then((function(){i.initialised&&i.getFlags()})):(i.withTraits=e(e({},i.withTraits||{}),t),void i.log("Set traits prior to identifying",i.withTraits));console.error(g("setTraits"))},this.hasFeature=function(t){var e=i.flags&&i.flags[t.toLowerCase().replace(/ /g,"_")],n=!1;return e&&e.enabled&&(n=!0),i.evaluateFlag(t),n},s=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:l.fetch,this.log("Constructing flagsmith instance "+t),t.eventSource&&(r=t.eventSource),a=t.AsyncStorage}return t.prototype.init=function(t){var i=this,n=t.environmentID,o=t.api,l=void 0===o?c:o,g=t.headers,d=t.onChange,f=t.cacheFlags,v=t.onError,p=t.defaultFlags,y=t.fetch,m=t.preventFetch,O=t.enableLogs,S=t.enableDynatrace,E=t.enableAnalytics,b=t.realtime,I=t.eventSourceUrl,_=void 0===I?"http://sse-lb-eu-west-2-7ba834a-1075512661.eu-west-2.elb.amazonaws.com.global.prod.fastly.net/sse/environments/$ENVIRONMENT/stream":I,T=t.AsyncStorage,w=t.identity,x=t.traits,F=t._trigger,N=t.state,j=t.cacheOptions,R=t.angularHttpClient;return new Promise((function(t,o){if(i.environmentID=n,i.api=l,i.headers=g,i.getFlagInterval=null,i.analyticsInterval=null,i.onChange=d,i.trigger=F,i.onError=v,i.identity=w,i.withTraits=x,i.enableLogs=O,i.cacheOptions=j?{skipAPI:!!j.skipAPI,ttl:j.ttl||0}:i.cacheOptions,!i.cacheOptions.ttl&&i.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),y&&(s=y),i.enableAnalytics=E||!1,i.flags=Object.assign({},p)||{},i.initialised=!0,i.ticks=1e4,b){var c=_.replace("$ENVIRONMENT",n);r?i.eventSource||(i.log("Creating event source with url "+c),i.eventSource=new r(c),i.eventSource.addEventListener("environment_updated",(function(t){i.log("Received eventsource message"),i.getFlags()}))):i.log("Error, EventSource is undefined")}if(i.log("Initialising with properties",{environmentID:n,api:l,headers:g,onChange:d,cacheFlags:f,onError:v,defaultFlags:p,preventFetch:m,enableLogs:O,enableAnalytics:E,AsyncStorage:a,identity:w,traits:x,_trigger:F,state:N,angularHttpClient:R},i),i.timer=i.enableLogs?(new Date).valueOf():null,T&&(a=T),i.cacheFlags=void 0!==a&&f,i.setState(N),!n)throw o("Please specify a environment id"),"Please specify a environment id";S&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):i.dtrum=dtrum),R&&(s=function(t,e){var i=e.headers,n=e.method,s=e.body;return new Promise((function(e){switch(n){case"GET":return R.get(t,{headers:i}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return R.post(t,s,{headers:i}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}))}}))}),a&&"undefined"!=typeof window&&a.getItem(u).then((function(t){if(t)try{i.evaluationEvent=JSON.parse(t)}catch(t){i.evaluationEvent={}}else i.evaluationEvent={};return i.analyticsInterval=setInterval(i.analyticsFlags,i.ticks),!0})),i.enableAnalytics&&(i.analyticsInterval&&clearInterval(i.analyticsInterval),a&&"undefined"!=typeof window&&a.getItem(u,(function(t,n){if(n){var s=JSON.parse(n);s&&(N=i.getState(),i.log("Retrieved events from cache",n),i.setState(e(e({},N),{evaluationEvent:s})))}return!0}))),f?a&&"undefined"!=typeof window&&a.getItem(h,(function(e,n){if(n)try{var s=JSON.parse(n),a=!1;if(s&&s.api===i.api&&s.environmentID===i.environmentID){var r=!0;i.cacheOptions.ttl&&(!s.ts||(new Date).valueOf()-s.ts>i.cacheOptions.ttl)&&s.ts&&(i.log("Ignoring cache, timestamp is too old ts:"+s.ts+" ttl: "+i.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-s.ts)+"ms"),r=!1),r&&(a=!0,i.setState(s),i.log("Retrieved flags from cache",s))}i.flags?(i.trigger&&i.trigger(),i.onChange&&i.onChange(null,{isFromServer:!1}),i.oldFlags=i.flags,t(!0),i.cacheOptions.skipAPI&&a&&i.log("Skipping API, using cache"),m||i.cacheOptions.skipAPI&&a||i.getFlags()):m?t(!0):i.getFlags(t,o)}catch(t){i.log("Exception fetching cached logs",t)}else m?(p&&(i.trigger&&i.trigger(),i.onChange&&i.onChange(null,{isFromServer:!1})),t(!0)):i.getFlags(t,o);return!0})):m?(p&&(i.trigger&&i.trigger(),i.onChange&&i.onChange(null,{isFromServer:!1})),t(!0)):i.getFlags(t,o)})).catch((function(t){i.log("Error during initialisation ",t),v&&v(t)}))},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,i){return this.identity=t,this.log("Identify: "+this.identity),i&&(this.withTraits=e(e({},this.withTraits||{}),i)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||c,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent)},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,i(["FLAGSMITH:",(new Date).valueOf()-this.timer,"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),a.setItem(h,t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),a.setItem(u,t)}},t.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){clearInterval(this.getFlagInterval),this.getFlagInterval=null},t.prototype.getSegments=function(){},t}();function f(t){var e=t.fetch,i=t.AsyncStorage,n=t.eventSource;return new d({fetch:e,AsyncStorage:i,eventSource:n})}var v=function(t,e,i){var n="shortString",s=!0;"number"==typeof i&&(n="javaDouble",s=!1),t[n]=t[n]||{},t[n][e]=s?i+"":i};var p=n(Object.freeze({__proto__:null,default:class{ERROR=-1;CONNECTING=0;OPEN=1;CLOSED=2;constructor(t,e={}){if(this.interval=e.pollingInterval||5e3,this.lastEventId=null,this.lastIndexProcessed=0,this.eventType=void 0,this.status=this.CONNECTING,this.eventHandlers={open:[],message:[],error:[],close:[]},this.method=e.method||"GET",this.timeout=e.timeOut||0,this.headers=e.headers||{},this.body=e.body||void 0,this.debug=e.debug||!1,this._xhr=null,this._pollTimer=null,!t||"string"!=typeof t&&"function"!=typeof t.toString)throw new SyntaxError("[EventSource] Invalid URL argument.");"function"==typeof t.toString?this.url=t.toString():this.url=t,this._pollAgain(500)}_pollAgain(t){this._pollTimer=setTimeout((()=>{this.open()}),t)}open(){try{if(this.lastIndexProcessed=0,this.status=this.CONNECTING,this._xhr=new XMLHttpRequest,this._xhr.open(this.method,this.url,!0),this.headers)for(const[t,e]of Object.entries(this.headers))this._xhr.setRequestHeader(t,e);this._xhr.setRequestHeader("Accept","text/event-stream"),this._xhr.setRequestHeader("Cache-Control","no-cache"),this._xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!==this.lastEventId&&this._xhr.setRequestHeader("Last-Event-ID",this.lastEventId),this._xhr.timeout=this.timeout,this._xhr.onreadystatechange=()=>{const t=this._xhr;this.debug&&console.debug(`[EventSource][onreadystatechange] ReadyState: ${t.readyState}, status: ${t.status}`),[XMLHttpRequest.DONE,XMLHttpRequest.LOADING].includes(t.readyState)&&(t.status>=200&&t.status<400?(this.status===this.CONNECTING&&(this.status=this.OPEN,this.dispatch("open",{type:"open"})),this._handleEvent(t.responseText||""),t.readyState===XMLHttpRequest.DONE&&(this.debug&&console.debug("[EventSource][onreadystatechange][DONE] Operation done. Reconnecting..."),this._pollAgain(this.interval))):this.status!==this.CLOSED&&(0!==this._xhr.status&&this.dispatch("error",{type:"error",message:t.responseText,xhrStatus:t.status,xhrState:t.readyState}),[XMLHttpRequest.DONE,XMLHttpRequest.UNSENT].includes(t.readyState)&&(this.debug&&console.debug("[EventSource][onreadystatechange][ERROR] Response status error. Reconnecting..."),this._pollAgain(this.interval))))},this._xhr.onerror=t=>{this.status,this.ERROR,this.dispatch("error",{type:"error",message:this._xhr.responseText,xhrStatus:this._xhr.status,xhrState:this._xhr.readyState})},this.body?this._xhr.send(this.body):this._xhr.send(),this.timeout>0&&setTimeout((()=>{this._xhr.readyState===XMLHttpRequest.LOADING&&(this.dispatch("error",{type:"timeout"}),this.close())}),this.timeout)}catch(t){this.status=this.ERROR,this.dispatch("error",{type:"exception",message:t.message,error:t})}}_handleEvent(t){const e=t.substr(this.lastIndexProcessed).split("\n");this.lastIndexProcessed=t.lastIndexOf("\n\n")+2;let i=[],n=0,s="";for(let t=0;t<e.length;t++)if(s=e[t].replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,""),0===s.indexOf("event"))this.eventType=s.replace(/event:?\s*/,"");else if(0===s.indexOf("retry"))n=parseInt(s.replace(/retry:?\s*/,""),10),isNaN(n)||(this.interval=n);else if(0===s.indexOf("data"))i.push(s.replace(/data:?\s*/,""));else if(0===s.indexOf("id:"))this.lastEventId=s.replace(/id:?\s*/,"");else if(0===s.indexOf("id"))this.lastEventId=null;else if(""===s&&i.length>0){const t=this.eventType||"message",e={type:t,data:i.join("\n"),url:this.url,lastEventId:this.lastEventId};this.dispatch(t,e),i=[],this.eventType=void 0}}addEventListener(t,e){void 0===this.eventHandlers[t]&&(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e)}removeEventListener(t,e){void 0!==this.eventHandlers[t]&&(this.eventHandlers[t]=this.eventHandlers[t].filter((t=>t!==e)))}removeAllEventListeners(t){const e=Object.keys(this.eventHandlers);if(void 0===t)for(const t of e)this.eventHandlers[t]=[];else{if(!e.includes(t))throw Error(`[EventSource] '${t}' type is not supported event type.`);this.eventHandlers[t]=[]}}dispatch(t,e){if(Object.keys(this.eventHandlers).includes(t))for(const i of Object.values(this.eventHandlers[t]))i(e)}close(){this.status=this.CLOSED,clearTimeout(this._pollTimer),this._xhr&&this._xhr.abort(),this.dispatch("close",{type:"close"})}}})),y=f({eventSource:p.default});t.createFlagsmithInstance=()=>f({eventSource:p.default}),t.default=y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
