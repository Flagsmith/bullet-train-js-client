!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["react-native-flagsmith"]={})}(this,(function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},e.apply(this,arguments)};function n(t,e,n){if(n||2===arguments.length)for(var i,a=0,r=e.length;a<r;a++)!i&&a in e||(i||(i=Array.prototype.slice.call(e,0,a)),i[a]=e[a]);return t.concat(i||Array.prototype.slice.call(e))}var i,a,r,s=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){if(e.constructor!==n.constructor)return!1;var i,a,r;if(Array.isArray(e)){if((i=e.length)!=n.length)return!1;for(a=i;0!=a--;)if(!t(e[a],n[a]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if((i=(r=Object.keys(e)).length)!==Object.keys(n).length)return!1;for(a=i;0!=a--;)if(!Object.prototype.hasOwnProperty.call(n,r[a]))return!1;for(a=i;0!=a--;){var s=r[a];if(!t(e[s],n[s]))return!1}return!0}return e!=e&&n!=n},o=void 0!==o?o:"undefined"!=typeof window?window:{},l="BULLET_TRAIN_DB",c="BULLET_TRAIN_EVENT",u="https://edge.api.flagsmith.com/api/v1/",h=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},g=function(){function t(t){var n=this;this.eventSource=null,this.getJSON=function(t,e,a){var r=n,s=r.environmentID,o=r.headers,l={method:e||"GET",body:a,headers:{"x-environment-key":s}};return e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),i(t,l).then((function(t){return t.text().then((function(e){var n=e;try{n=JSON.parse(e)}catch(t){}return t.ok?n:Promise.reject(n)}))}))},this.getFlags=function(t,i){var a=n,r=a.onChange,o=a.onError,l=a.identity,c=a.api,u=!1;n.log("Get Flags");var h=function(t){var i=t.flags,a=t.traits;l&&(n.withTraits=!1);var o={},c={};a=a||[],(i=i||[]).forEach((function(t){o[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),a.forEach((function(t){c[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),n.oldFlags=e({},n.flags);var u=s(n.flags,o),h=s(n.traits,c);if(n.flags=o,n.traits=c,n.updateStorage(),n.dtrum){var g={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(n.flags).map((function(t){v(g,"flagsmith_value_"+t,n.getValue(t)),v(g,"flagsmith_enabled_"+t,n.hasFeature(t))})),Object.keys(n.traits).map((function(t){v(g,"flagsmith_trait_"+t,n.getTrait(t))})),n.log("Sending javaLongOrObject traits to dynatrace",g.javaLongOrObject),n.log("Sending date traits to dynatrace",g.date),n.log("Sending shortString traits to dynatrace",g.shortString),n.log("Sending javaDouble to dynatrace",g.javaDouble),n.dtrum.sendSessionProperties(g.javaLongOrObject,g.date,g.shortString,g.javaDouble)}n.trigger&&n.trigger(),r&&r(n.oldFlags,{isFromServer:!0,flagsChanged:!u,traitsChanged:!h})};return l?Promise.all([n.withTraits?n.getJSON(c+"identities/","POST",JSON.stringify({identifier:l,traits:Object.keys(n.withTraits).map((function(t){return{trait_key:t,trait_value:n.withTraits[t]}}))})):n.getJSON(c+"identities/?identifier="+encodeURIComponent(l))]).then((function(e){n.withTraits=!1,h(e[0]),t&&!u&&(u=!0,t())})).catch((function(t){var e=t.message;o&&o({message:e})})):Promise.all([n.getJSON(c+"flags/")]).then((function(e){h({flags:e[0]}),t&&!u&&(u=!0,t())})).catch((function(t){i&&!u&&(u=!0,i(t)),o&&o(t)}))},this.analyticsFlags=function(){var t=n.api;if(0!==Object.getOwnPropertyNames(n.evaluationEvent).length)return n.getJSON(t+"analytics/flags/","POST",JSON.stringify(n.evaluationEvent)).then((function(t){var i=n.getState();n.setState(e(e({},i),{evaluationEvent:{}})),n.updateEventStorage()})).catch((function(t){n.log("Exception fetching evaluationEvent",t)}))},this.analyticsInterval=null,this.api=null,this.cacheFlags=null,this.ts=null,this.enableAnalytics=null,this.enableLogs=null,this.environmentID=null,this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=null,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(n.enableAnalytics){if(!n.evaluationEvent)return;void 0===n.evaluationEvent[t]&&(n.evaluationEvent[t]=0),n.evaluationEvent[t]+=1}n.updateEventStorage()},this.getValue=function(t){var e=n.flags&&n.flags[t.toLowerCase().replace(/ /g,"_")],i=null;return e&&(i=e.value),n.evaluateFlag(t),i},this.getTrait=function(t){return n.traits&&n.traits[t.toLowerCase().replace(/ /g,"_")]},this.setTrait=function(t,i){var a=n,r=a.getJSON,s=a.identity,o=a.api;if(o){var l={};if(l[t]=i,!n.identity)return n.withTraits=e(e({},n.withTraits||{}),l),void n.log("Set trait prior to identifying",n.withTraits);var c={identity:{identifier:s},trait_key:t,trait_value:i};return r("".concat(o,"traits/"),"POST",JSON.stringify(c)).then((function(){n.initialised&&n.getFlags()}))}console.error(h("setTrait"))},this.setTraits=function(t){var i=n;i.getJSON;var a=i.identity,r=i.api;if(r)return t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),n.identity?n.getJSON(r+"identities/","POST",JSON.stringify({identifier:a,traits:Object.keys(t).map((function(e){return{trait_key:e,trait_value:t[e]}}))})).then((function(){n.initialised&&n.getFlags()})):(n.withTraits=e(e({},n.withTraits||{}),t),void n.log("Set traits prior to identifying",n.withTraits));console.error(h("setTraits"))},this.hasFeature=function(t){var e=n.flags&&n.flags[t.toLowerCase().replace(/ /g,"_")],i=!1;return e&&e.enabled&&(i=!0),n.evaluateFlag(t),i},i=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:o.fetch,this.log("Constructing flagsmith instance "+t),t.eventSource&&(r=t.eventSource),a=t.AsyncStorage}return t.prototype.init=function(t){var n=this,s=t.environmentID,o=t.api,h=void 0===o?u:o,g=t.headers,f=t.onChange,v=t.cacheFlags,d=t.onError,p=t.defaultFlags,y=t.preventFetch,S=t.enableLogs,m=t.enableDynatrace,O=t.enableAnalytics,I=t.realtime,E=t.eventSourceUrl,b=void 0===E?h:E,T=t.AsyncStorage,w=t.identity,N=t.traits,F=t._trigger,P=t.state,L=t.cacheOptions,_=t.angularHttpClient;return new Promise((function(t,o){if(n.environmentID=s,n.api=h,n.headers=g,n.getFlagInterval=null,n.analyticsInterval=null,n.onChange=f,n.trigger=F,n.onError=d,n.identity=w,n.withTraits=N,n.enableLogs=S,n.cacheOptions=L?{skipAPI:!!L.skipAPI,ttl:L.ttl||0}:n.cacheOptions,!n.cacheOptions.ttl&&n.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),n.enableAnalytics=O||!1,n.flags=Object.assign({},p)||{},n.initialised=!0,n.ticks=1e4,I){var u=b+"environment/"+s;r?n.eventSource||(n.log("Creating event source with url "+u),n.eventSource=new r(u),n.eventSource.addEventListener("update",(function(t){n.log("Received eventsource update")})),n.eventSource.addEventListener("message",(function(t){n.log("Received eventsource message")})),n.eventSource.addEventListener("notice",(function(t){n.log("Received eventsource notice")}))):n.log("Error, EventSource is undefined")}if(n.log("Initialising with properties",{environmentID:s,api:h,headers:g,onChange:f,cacheFlags:v,onError:d,defaultFlags:p,preventFetch:y,enableLogs:S,enableAnalytics:O,AsyncStorage:a,identity:w,traits:N,_trigger:F,state:P,angularHttpClient:_},n),n.timer=n.enableLogs?(new Date).valueOf():null,T&&(a=T),n.cacheFlags=void 0!==a&&v,n.setState(P),!s)throw o("Please specify a environment id"),"Please specify a environment id";m&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):n.dtrum=dtrum),_&&(i=function(t,e){var n=e.headers,i=e.method,a=e.body;return new Promise((function(e){switch(i){case"GET":return _.get(t,{headers:n}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return _.post(t,a,{headers:n}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}))}}))}),a&&"undefined"!=typeof window&&a.getItem(c).then((function(t){if(t)try{n.evaluationEvent=JSON.parse(t)}catch(t){n.evaluationEvent={}}else n.evaluationEvent={};return n.analyticsInterval=setInterval(n.analyticsFlags,n.ticks),!0})),n.enableAnalytics&&(n.analyticsInterval&&clearInterval(n.analyticsInterval),a&&"undefined"!=typeof window&&a.getItem(c,(function(t,i){if(i){var a=JSON.parse(i);a&&(P=n.getState(),n.log("Retrieved events from cache",i),n.setState(e(e({},P),{evaluationEvent:a})))}return!0}))),v?a&&"undefined"!=typeof window&&a.getItem(l,(function(e,i){if(i)try{var a=JSON.parse(i),r=!1;if(a&&a.api===n.api&&a.environmentID===n.environmentID){var s=!0;n.cacheOptions.ttl&&(!a.ts||(new Date).valueOf()-a.ts>n.cacheOptions.ttl)&&a.ts&&(n.log("Ignoring cache, timestamp is too old ts:"+a.ts+" ttl: "+n.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-a.ts)+"ms"),s=!1),s&&(r=!0,n.setState(a),n.log("Retrieved flags from cache",a))}n.flags?(n.trigger&&n.trigger(),n.onChange&&n.onChange(null,{isFromServer:!1}),n.oldFlags=n.flags,t(!0),n.cacheOptions.skipAPI&&r&&n.log("Skipping API, using cache"),y||n.cacheOptions.skipAPI&&r||n.getFlags()):y?t(!0):n.getFlags(t,o)}catch(t){n.log("Exception fetching cached logs",t)}else y?(p&&(n.trigger&&n.trigger(),n.onChange&&n.onChange(null,{isFromServer:!1})),t(!0)):n.getFlags(t,o);return!0})):y?(p&&(n.trigger&&n.trigger(),n.onChange&&n.onChange(null,{isFromServer:!1})),t(!0)):n.getFlags(t,o)})).catch((function(t){return d&&d(t)}))},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,n){return this.identity=t,this.log("Identify: "+this.identity),n&&(this.withTraits=e(e({},this.withTraits||{}),n)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||u,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent)},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,n(["FLAGSMITH:",(new Date).valueOf()-this.timer,"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),a.setItem(l,t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),a.setItem(c,t)}},t.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){clearInterval(this.getFlagInterval),this.getFlagInterval=null},t.prototype.getSegments=function(){},t}();function f(t){var e=t.fetch,n=t.AsyncStorage,i=t.eventSource;return new g({fetch:e,AsyncStorage:n,eventSource:i})}var v=function(t,e,n){var i="shortString",a=!0;"number"==typeof n&&(i="javaDouble",a=!1),t[i]=t[i]||{},t[i][e]=a?n+"":n},d=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,p=function(t,e){var n,i=this,a=500,r=null,s=0;if(!t||"string"!=typeof t)throw new SyntaxError("Not enough arguments");function o(t){i._pollTimer=setTimeout((function(){l.call(i)}),t)}function l(){try{if(i.readyState==i.CLOSED)return;var t=new XMLHttpRequest;t.open(i.OPTIONS.method||"GET",i.URL,!0),i.OPTIONS&&i.OPTIONS.headers&&Object.keys(i.OPTIONS.headers).forEach((e=>{t.setRequestHeader(e,i.OPTIONS.headers[e])})),t.setRequestHeader("Accept","text/event-stream"),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!=r&&t.setRequestHeader("Last-Event-ID",r),s=0,t.timeout=this.OPTIONS&&void 0!==this.OPTIONS.timeout?this.OPTIONS.timeout:5e4,t.onreadystatechange=function(){if(3==this.readyState||4==this.readyState&&200==this.status){i.readyState==i.CONNECTING&&(i.readyState=i.OPEN,i.dispatchEvent("open",{type:"open"}));var t="";try{t=this.responseText||""}catch(t){}var e=t.substr(s).split("\n"),l=[],c=0,u=0,h="";for(s=t.lastIndexOf("\n\n")+2;c<e.length;c++)if(0==(h=e[c].replace(d,"")).indexOf("event"))n=h.replace(/event:?\s*/,"");else if(0==h.indexOf("retry"))u=parseInt(h.replace(/retry:?\s*/,"")),isNaN(u)||(a=u);else if(0==h.indexOf("data"))l.push(h.replace(/data:?\s*/,""));else if(0==h.indexOf("id:"))r=h.replace(/id:?\s*/,"");else if(0==h.indexOf("id"))r=null;else if(""==h&&l.length){var g=new y(l.join("\n"),i.url,r);i.dispatchEvent(n||"message",g),l=[],n=void 0}4==this.readyState&&o(a)}else i.readyState!==i.CLOSED&&(4==this.readyState||0==this.readyState)&&o(a)},t.onerror=function(t){i.readyState=i.CONNECTING,i.dispatchEvent("error",{type:"error",message:this.responseText})},i.OPTIONS.body?t.send(i.OPTIONS.body):t.send(),t.timeout>0&&setTimeout((function(){t.abort()}),t.timeout),i._xhr=t}catch(t){i.dispatchEvent("error",{type:"error",data:t.message})}}this.URL=t,this.OPTIONS=e,this.readyState=this.CONNECTING,this._pollTimer=null,this._xhr=null,l()};p.prototype={close:function(){this.readyState=this.CLOSED,clearInterval(this._pollTimer),this._xhr.abort()},CONNECTING:0,OPEN:1,CLOSED:2,dispatchEvent:function(t,e){var n=this["_"+t+"Handlers"];if(n)for(var i=0;i<n.length;i++)n[i].call(this,e);this["on"+t]&&this["on"+t].call(this,e)},addEventListener:function(t,e){this["_"+t+"Handlers"]||(this["_"+t+"Handlers"]=[]),this["_"+t+"Handlers"].push(e)},removeEventListener:function(t,e){var n=this["_"+t+"Handlers"];if(n)for(var i=n.length-1;i>=0;--i)if(n[i]===e){n.splice(i,1);break}},onerror:null,onmessage:null,onopen:null,readyState:0,URL:""};var y=function(t,e,n){this.data=t,this.origin=e,this.lastEventId=n||""};y.prototype={data:null,type:"message",lastEventId:"",origin:""};class S{constructor(t,e={}){this.url=t,this.options=e,this.eventSource=new p(t,e),this.listeners=[]}addEventListener(t,e){this.eventSource.addEventListener(t,e);return this.listeners.push({remove:()=>{this.removeListener(t,e)},type:t,listener:e}),this.listeners[this.listeners.length-1]}removeAllListeners(){this.listeners.map((t=>{t.remove()}))}removeListener(t,e){this.eventSource.removeEventListener(t,e)}close(){this.eventSource.close()}}var m=f({eventSource:S});t.createFlagsmithInstance=()=>f({eventSource:S}),t.default=m,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
