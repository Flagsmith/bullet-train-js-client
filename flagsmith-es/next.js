var t=function(){return t=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},t.apply(this,arguments)};function e(t,e,i){if(i||2===arguments.length)for(var n,a=0,r=e.length;a<r;a++)!n&&a in e||(n||(n=Array.prototype.slice.call(e,0,a)),n[a]=e[a]);return t.concat(n||Array.prototype.slice.call(e))}var i,n,a=function t(e,i){if(e===i)return!0;if(e&&i&&"object"==typeof e&&"object"==typeof i){if(e.constructor!==i.constructor)return!1;var n,a,r;if(Array.isArray(e)){if((n=e.length)!=i.length)return!1;for(a=n;0!=a--;)if(!t(e[a],i[a]))return!1;return!0}if(e.constructor===RegExp)return e.source===i.source&&e.flags===i.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===i.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===i.toString();if((n=(r=Object.keys(e)).length)!==Object.keys(i).length)return!1;for(a=n;0!=a--;)if(!Object.prototype.hasOwnProperty.call(i,r[a]))return!1;for(a=n;0!=a--;){var s=r[a];if(!t(e[s],i[s]))return!1}return!0}return e!=e&&i!=i},r=void 0!==r?r:"undefined"!=typeof window?window:{},s="https://edge.api.flagsmith.com/api/v1/",o=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},l=function(){function l(e){var s=this;this.getJSON=function(t,e,n){var a=s,r=a.environmentID,o=a.headers,l={method:e||"GET",body:n,headers:{"x-environment-key":r}};return e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),i(t,l).then((function(t){return t.text().then((function(e){var i=e;try{i=JSON.parse(e)}catch(t){}return t.ok?i:Promise.reject(i)}))}))},this.getFlags=function(e,i){var n=s,r=n.onChange,o=n.onError,l=n.identity,g=n.api,u=!1;s.log("Get Flags");var h=function(e){var i=e.flags,n=e.traits;l&&(s.withTraits=!1);var o={},g={};n=n||[],(i=i||[]).forEach((function(t){o[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),n.forEach((function(t){g[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),s.oldFlags=t({},s.flags);var u=a(s.flags,o),h=a(s.traits,g);if(s.flags=o,s.traits=g,s.updateStorage(),s.dtrum){var f={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(s.flags).map((function(t){c(f,"flagsmith_value_"+t,s.getValue(t)),c(f,"flagsmith_enabled_"+t,s.hasFeature(t))})),Object.keys(s.traits).map((function(t){c(f,"flagsmith_trait_"+t,s.getTrait(t))})),s.log("Sending javaLongOrObject traits to dynatrace",f.javaLongOrObject),s.log("Sending date traits to dynatrace",f.date),s.log("Sending shortString traits to dynatrace",f.shortString),s.log("Sending javaDouble to dynatrace",f.javaDouble),s.dtrum.sendSessionProperties(f.javaLongOrObject,f.date,f.shortString,f.javaDouble)}s.trigger&&s.trigger(),r&&r(s.oldFlags,{isFromServer:!0,flagsChanged:!u,traitsChanged:!h})};return l?Promise.all([s.withTraits?s.getJSON(g+"identities/","POST",JSON.stringify({identifier:l,traits:Object.keys(s.withTraits).map((function(t){return{trait_key:t,trait_value:s.withTraits[t]}}))})):s.getJSON(g+"identities/?identifier="+encodeURIComponent(l))]).then((function(t){s.withTraits=!1,h(t[0]),e&&!u&&(u=!0,e())})).catch((function(t){var e=t.message;o&&o({message:e})})):Promise.all([s.getJSON(g+"flags/")]).then((function(t){h({flags:t[0]}),e&&!u&&(u=!0,e())})).catch((function(t){i&&!u&&(u=!0,i(t)),o&&o(t)}))},this.analyticsFlags=function(){var e=s.api;if(0!==Object.getOwnPropertyNames(s.evaluationEvent).length)return s.getJSON(e+"analytics/flags/","POST",JSON.stringify(s.evaluationEvent)).then((function(e){var i=s.getState();s.setState(t(t({},i),{evaluationEvent:{}})),s.updateEventStorage()})).catch((function(t){s.log("Exception fetching evaluationEvent",t)}))},this.analyticsInterval=null,this.api=null,this.cacheFlags=null,this.ts=null,this.enableAnalytics=null,this.enableLogs=null,this.environmentID=null,this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=null,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(s.enableAnalytics){if(!s.evaluationEvent)return;void 0===s.evaluationEvent[t]&&(s.evaluationEvent[t]=0),s.evaluationEvent[t]+=1}s.updateEventStorage()},this.getValue=function(t){var e=s.flags&&s.flags[t.toLowerCase().replace(/ /g,"_")],i=null;return e&&(i=e.value),s.evaluateFlag(t),i},this.getTrait=function(t){return s.traits&&s.traits[t.toLowerCase().replace(/ /g,"_")]},this.setTrait=function(e,i){var n=s,a=n.getJSON,r=n.identity,l=n.api;if(l){var g={};if(g[e]=i,!s.identity)return s.withTraits=t(t({},s.withTraits||{}),g),void s.log("Set trait prior to identifying",s.withTraits);var c={identity:{identifier:r},trait_key:e,trait_value:i};return a("".concat(l,"traits/"),"POST",JSON.stringify(c)).then((function(){s.initialised&&s.getFlags()}))}console.error(o("setTrait"))},this.setTraits=function(e){var i=s;i.getJSON;var n=i.identity,a=i.api;if(a)return e&&"object"==typeof e||console.error("Expected object for flagsmith.setTraits"),s.identity?s.getJSON(a+"identities/","POST",JSON.stringify({identifier:n,traits:Object.keys(e).map((function(t){return{trait_key:t,trait_value:e[t]}}))})).then((function(){s.initialised&&s.getFlags()})):(s.withTraits=t(t({},s.withTraits||{}),e),void s.log("Set traits prior to identifying",s.withTraits));console.error(o("setTraits"))},this.hasFeature=function(t){var e=s.flags&&s.flags[t.toLowerCase().replace(/ /g,"_")],i=!1;return e&&e.enabled&&(i=!0),s.evaluateFlag(t),i},i=e.fetch?e.fetch:"undefined"!=typeof fetch?fetch:r.fetch,n=e.AsyncStorage}return l.prototype.init=function(e){var a=this,r=e.environmentID,o=e.api,l=void 0===o?s:o,g=e.headers,c=e.onChange,u=e.cacheFlags,h=e.onError,f=e.defaultFlags,v=e.preventFetch,p=e.enableLogs,d=e.enableDynatrace,y=e.enableAnalytics,m=e.AsyncStorage,S=e.identity,O=e.traits,b=e._trigger,I=e.state,w=e.cacheOptions,E=e.angularHttpClient;return new Promise((function(e,s){if(a.environmentID=r,a.api=l,a.headers=g,a.getFlagInterval=null,a.analyticsInterval=null,a.onChange=c,a.trigger=b,a.onError=h,a.identity=S,a.withTraits=O,a.enableLogs=p,a.cacheOptions=w?{skipAPI:!!w.skipAPI,ttl:w.ttl||0}:a.cacheOptions,!a.cacheOptions.ttl&&a.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),a.enableAnalytics=y||!1,a.flags=Object.assign({},f)||{},a.initialised=!0,a.ticks=1e4,a.log("Initialising with properties",{environmentID:r,api:l,headers:g,onChange:c,cacheFlags:u,onError:h,defaultFlags:f,preventFetch:v,enableLogs:p,enableAnalytics:y,AsyncStorage:n,identity:S,traits:O,_trigger:b,state:I,angularHttpClient:E},a),a.timer=a.enableLogs?(new Date).valueOf():null,m&&(n=m),a.cacheFlags=void 0!==n&&u,a.setState(I),!r)throw s("Please specify a environment id"),"Please specify a environment id";d&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):a.dtrum=dtrum),E&&(i=function(t,e){var i=e.headers,n=e.method,a=e.body;return new Promise((function(e){switch(n){case"GET":return E.get(t,{headers:i}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return E.post(t,a,{headers:i}).subscribe((function(t){e({ok:1,text:function(){return Promise.resolve(t)}})}))}}))}),n&&"undefined"!=typeof window&&n.getItem("BULLET_TRAIN_EVENT").then((function(t){if(t)try{a.evaluationEvent=JSON.parse(t)}catch(t){a.evaluationEvent={}}else a.evaluationEvent={};return a.analyticsInterval=setInterval(a.analyticsFlags,a.ticks),!0})),a.enableAnalytics&&(a.analyticsInterval&&clearInterval(a.analyticsInterval),n&&"undefined"!=typeof window&&n.getItem("BULLET_TRAIN_EVENT",(function(e,i){if(i){var n=JSON.parse(i);n&&(I=a.getState(),a.log("Retrieved events from cache",i),a.setState(t(t({},I),{evaluationEvent:n})))}return!0}))),u?n&&"undefined"!=typeof window&&n.getItem("BULLET_TRAIN_DB",(function(t,i){if(i)try{var n=JSON.parse(i),r=!1;if(n&&n.api===a.api&&n.environmentID===a.environmentID){var o=!0;a.cacheOptions.ttl&&(!n.ts||(new Date).valueOf()-n.ts>a.cacheOptions.ttl)&&n.ts&&(a.log("Ignoring cache, timestamp is too old ts:"+n.ts+" ttl: "+a.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-n.ts)+"ms"),o=!1),o&&(r=!0,a.setState(n),a.log("Retrieved flags from cache",n))}a.flags?(a.trigger&&a.trigger(),a.onChange&&a.onChange(null,{isFromServer:!1}),a.oldFlags=a.flags,e(!0),a.cacheOptions.skipAPI&&r&&a.log("Skipping API, using cache"),v||a.cacheOptions.skipAPI&&r||a.getFlags()):v?e(!0):a.getFlags(e,s)}catch(t){a.log("Exception fetching cached logs",t)}else v?(f&&(a.trigger&&a.trigger(),a.onChange&&a.onChange(null,{isFromServer:!1})),e(!0)):a.getFlags(e,s);return!0})):v?(f&&(a.trigger&&a.trigger(),a.onChange&&a.onChange(null,{isFromServer:!1})),e(!0)):a.getFlags(e,s)})).catch((function(t){return h&&h(t)}))},l.prototype.getAllFlags=function(){return this.flags},l.prototype.identify=function(e,i){return this.identity=e,this.log("Identify: "+this.identity),i&&(this.withTraits=t(t({},this.withTraits||{}),i)),this.initialised?this.getFlags():Promise.resolve()},l.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},l.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||s,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent)},l.prototype.log=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];this.enableLogs&&console.log.apply(this,e(["FLAGSMITH:",(new Date).valueOf()-this.timer,"ms"],t,!0))},l.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),n.setItem("BULLET_TRAIN_DB",t)}},l.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),n.setItem("BULLET_TRAIN_EVENT",t)}},l.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},l.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},l.prototype.stopListening=function(){clearInterval(this.getFlagInterval),this.getFlagInterval=null},l.prototype.getSegments=function(){},l}();function g(t){var e=t.fetch,i=t.AsyncStorage;return new l({fetch:e,AsyncStorage:i})}var c=function(t,e,i){var n="shortString",a=!0;"number"==typeof i&&(n="javaDouble",a=!1),t[n]=t[n]||{},t[n][e]=a?i+"":i},u=g({}),h=function(){return g({})};export{h as createFlagsmithInstance,u as default};
//# sourceMappingURL=next.js.map
