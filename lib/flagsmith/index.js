!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flagsmith={})}(this,(function(t){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n={},r={exports:{}};!function(t,n){var r="__lodash_hash_undefined__",i=9007199254740991,o="[object Arguments]",a="[object Function]",s="[object Object]",l=/^\[object .+?Constructor\]$/,u=/^(?:0|[1-9]\d*)$/,c={};c["[object Float32Array]"]=c["[object Float64Array]"]=c["[object Int8Array]"]=c["[object Int16Array]"]=c["[object Int32Array]"]=c["[object Uint8Array]"]=c["[object Uint8ClampedArray]"]=c["[object Uint16Array]"]=c["[object Uint32Array]"]=!0,c[o]=c["[object Array]"]=c["[object ArrayBuffer]"]=c["[object Boolean]"]=c["[object DataView]"]=c["[object Date]"]=c["[object Error]"]=c[a]=c["[object Map]"]=c["[object Number]"]=c[s]=c["[object RegExp]"]=c["[object Set]"]=c["[object String]"]=c["[object WeakMap]"]=!1;var f="object"==typeof e&&e&&e.Object===Object&&e,h="object"==typeof self&&self&&self.Object===Object&&self,v=f||h||Function("return this")(),g=n&&!n.nodeType&&n,p=g&&t&&!t.nodeType&&t,d=p&&p.exports===g,y=d&&f.process,_=function(){try{var t=p&&p.require&&p.require("util").types;return t||y&&y.binding&&y.binding("util")}catch(t){}}(),m=_&&_.isTypedArray;function b(t,e,n){switch(n.length){case 0:return t.call(e);case 1:return t.call(e,n[0]);case 2:return t.call(e,n[0],n[1]);case 3:return t.call(e,n[0],n[1],n[2])}return t.apply(e,n)}var S,O,w,j=Array.prototype,E=Function.prototype,I=Object.prototype,A=v["__core-js_shared__"],F=E.toString,T=I.hasOwnProperty,C=(S=/[^.]+$/.exec(A&&A.keys&&A.keys.IE_PROTO||""))?"Symbol(src)_1."+S:"",P=I.toString,x=F.call(Object),D=RegExp("^"+F.call(T).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),N=d?v.Buffer:void 0,k=v.Symbol,L=v.Uint8Array,J=N?N.allocUnsafe:void 0,R=(O=Object.getPrototypeOf,w=Object,function(t){return O(w(t))}),z=Object.create,U=I.propertyIsEnumerable,M=j.splice,G=k?k.toStringTag:void 0,B=function(){try{var t=pt(Object,"defineProperty");return t({},"",{}),t}catch(t){}}(),$=N?N.isBuffer:void 0,q=Math.max,H=Date.now,V=pt(v,"Map"),K=pt(Object,"create"),W=function(){function t(){}return function(e){if(!At(e))return{};if(z)return z(e);t.prototype=e;var n=new t;return t.prototype=void 0,n}}();function X(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function Y(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function Q(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function Z(t){var e=this.__data__=new Y(t);this.size=e.size}function tt(t,e){var n=Ot(t),r=!n&&St(t),i=!n&&!r&&jt(t),o=!n&&!r&&!i&&Tt(t),a=n||r||i||o,s=a?function(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}(t.length,String):[],l=s.length;for(var u in t)!e&&!T.call(t,u)||a&&("length"==u||i&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||dt(u,l))||s.push(u);return s}function et(t,e,n){(void 0!==n&&!bt(t[e],n)||void 0===n&&!(e in t))&&it(t,e,n)}function nt(t,e,n){var r=t[e];T.call(t,e)&&bt(r,n)&&(void 0!==n||e in t)||it(t,e,n)}function rt(t,e){for(var n=t.length;n--;)if(bt(t[n][0],e))return n;return-1}function it(t,e,n){"__proto__"==e&&B?B(t,e,{configurable:!0,enumerable:!0,value:n,writable:!0}):t[e]=n}X.prototype.clear=function(){this.__data__=K?K(null):{},this.size=0},X.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},X.prototype.get=function(t){var e=this.__data__;if(K){var n=e[t];return n===r?void 0:n}return T.call(e,t)?e[t]:void 0},X.prototype.has=function(t){var e=this.__data__;return K?void 0!==e[t]:T.call(e,t)},X.prototype.set=function(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=K&&void 0===e?r:e,this},Y.prototype.clear=function(){this.__data__=[],this.size=0},Y.prototype.delete=function(t){var e=this.__data__,n=rt(e,t);return!(n<0)&&(n==e.length-1?e.pop():M.call(e,n,1),--this.size,!0)},Y.prototype.get=function(t){var e=this.__data__,n=rt(e,t);return n<0?void 0:e[n][1]},Y.prototype.has=function(t){return rt(this.__data__,t)>-1},Y.prototype.set=function(t,e){var n=this.__data__,r=rt(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this},Q.prototype.clear=function(){this.size=0,this.__data__={hash:new X,map:new(V||Y),string:new X}},Q.prototype.delete=function(t){var e=gt(this,t).delete(t);return this.size-=e?1:0,e},Q.prototype.get=function(t){return gt(this,t).get(t)},Q.prototype.has=function(t){return gt(this,t).has(t)},Q.prototype.set=function(t,e){var n=gt(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this},Z.prototype.clear=function(){this.__data__=new Y,this.size=0},Z.prototype.delete=function(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n},Z.prototype.get=function(t){return this.__data__.get(t)},Z.prototype.has=function(t){return this.__data__.has(t)},Z.prototype.set=function(t,e){var n=this.__data__;if(n instanceof Y){var r=n.__data__;if(!V||r.length<199)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new Q(r)}return n.set(t,e),this.size=n.size,this};var ot,at=function(t,e,n){for(var r=-1,i=Object(t),o=n(t),a=o.length;a--;){var s=o[ot?a:++r];if(!1===e(i[s],s,i))break}return t};function st(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":G&&G in Object(t)?function(t){var e=T.call(t,G),n=t[G];try{t[G]=void 0;var r=!0}catch(t){}var i=P.call(t);r&&(e?t[G]=n:delete t[G]);return i}(t):function(t){return P.call(t)}(t)}function lt(t){return Ft(t)&&st(t)==o}function ut(t){return!(!At(t)||function(t){return!!C&&C in t}(t))&&(Et(t)?D:l).test(function(t){if(null!=t){try{return F.call(t)}catch(t){}try{return t+""}catch(t){}}return""}(t))}function ct(t){if(!At(t))return function(t){var e=[];if(null!=t)for(var n in Object(t))e.push(n);return e}(t);var e=yt(t),n=[];for(var r in t)("constructor"!=r||!e&&T.call(t,r))&&n.push(r);return n}function ft(t,e,n,r,i){t!==e&&at(e,(function(o,a){if(i||(i=new Z),At(o))!function(t,e,n,r,i,o,a){var l=_t(t,n),u=_t(e,n),c=a.get(u);if(c)return void et(t,n,c);var f=o?o(l,u,n+"",t,e,a):void 0,h=void 0===f;if(h){var v=Ot(u),g=!v&&jt(u),p=!v&&!g&&Tt(u);f=u,v||g||p?Ot(l)?f=l:Ft(b=l)&&wt(b)?f=function(t,e){var n=-1,r=t.length;e||(e=Array(r));for(;++n<r;)e[n]=t[n];return e}(l):g?(h=!1,f=function(t,e){if(e)return t.slice();var n=t.length,r=J?J(n):new t.constructor(n);return t.copy(r),r}(u,!0)):p?(h=!1,d=u,y=!0?(_=d.buffer,m=new _.constructor(_.byteLength),new L(m).set(new L(_)),m):d.buffer,f=new d.constructor(y,d.byteOffset,d.length)):f=[]:function(t){if(!Ft(t)||st(t)!=s)return!1;var e=R(t);if(null===e)return!0;var n=T.call(e,"constructor")&&e.constructor;return"function"==typeof n&&n instanceof n&&F.call(n)==x}(u)||St(u)?(f=l,St(l)?f=function(t){return function(t,e,n,r){var i=!n;n||(n={});var o=-1,a=e.length;for(;++o<a;){var s=e[o],l=r?r(n[s],t[s],s,n,t):void 0;void 0===l&&(l=t[s]),i?it(n,s,l):nt(n,s,l)}return n}(t,Ct(t))}(l):At(l)&&!Et(l)||(f=function(t){return"function"!=typeof t.constructor||yt(t)?{}:W(R(t))}(u))):h=!1}var d,y,_,m;var b;h&&(a.set(u,f),i(f,u,r,o,a),a.delete(u));et(t,n,f)}(t,e,a,n,ft,r,i);else{var l=r?r(_t(t,a),o,a+"",t,e,i):void 0;void 0===l&&(l=o),et(t,a,l)}}),Ct)}function ht(t,e){return mt(function(t,e,n){return e=q(void 0===e?t.length-1:e,0),function(){for(var r=arguments,i=-1,o=q(r.length-e,0),a=Array(o);++i<o;)a[i]=r[e+i];i=-1;for(var s=Array(e+1);++i<e;)s[i]=r[i];return s[e]=n(a),b(t,this,s)}}(t,e,Dt),t+"")}var vt=B?function(t,e){return B(t,"toString",{configurable:!0,enumerable:!1,value:(n=e,function(){return n}),writable:!0});var n}:Dt;function gt(t,e){var n,r,i=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?i["string"==typeof e?"string":"hash"]:i.map}function pt(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return ut(n)?n:void 0}function dt(t,e){var n=typeof t;return!!(e=null==e?i:e)&&("number"==n||"symbol"!=n&&u.test(t))&&t>-1&&t%1==0&&t<e}function yt(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||I)}function _t(t,e){if(("constructor"!==e||"function"!=typeof t[e])&&"__proto__"!=e)return t[e]}var mt=function(t){var e=0,n=0;return function(){var r=H(),i=16-(r-n);if(n=r,i>0){if(++e>=800)return arguments[0]}else e=0;return t.apply(void 0,arguments)}}(vt);function bt(t,e){return t===e||t!=t&&e!=e}var St=lt(function(){return arguments}())?lt:function(t){return Ft(t)&&T.call(t,"callee")&&!U.call(t,"callee")},Ot=Array.isArray;function wt(t){return null!=t&&It(t.length)&&!Et(t)}var jt=$||function(){return!1};function Et(t){if(!At(t))return!1;var e=st(t);return e==a||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}function It(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=i}function At(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function Ft(t){return null!=t&&"object"==typeof t}var Tt=m?function(t){return function(e){return t(e)}}(m):function(t){return Ft(t)&&It(t.length)&&!!c[st(t)]};function Ct(t){return wt(t)?tt(t,!0):ct(t)}var Pt,xt=(Pt=function(t,e,n){ft(t,e,n)},ht((function(t,e){var n=-1,r=e.length,i=r>1?e[r-1]:void 0,o=r>2?e[2]:void 0;for(i=Pt.length>3&&"function"==typeof i?(r--,i):void 0,o&&function(t,e,n){if(!At(n))return!1;var r=typeof e;return!!("number"==r?wt(n)&&dt(e,n.length):"string"==r&&e in n)&&bt(n[e],t)}(e[0],e[1],o)&&(i=r<3?void 0:i,r=1),t=Object(t);++n<r;){var a=e[n];a&&Pt(t,a,n,i)}return t})));function Dt(t){return t}t.exports=xt}(r,r.exports),Object.defineProperty(n,"__esModule",{value:!0});var i,o=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},a=(i=r.exports)&&i.__esModule?i:{default:i};var s={getItem:function(t,e){return s.multiGet([t]).then((function(t){return t[0][1]})).then((function(t){return e&&e(null,t),t})).catch((function(t){return e&&e(t,null),t}))},setItem:function(t,e,n){return s.multiSet([[t,e]]).then((function(t){return n&&n(null,t),t})).catch((function(t){return n&&n(t,null),t}))},getAllKeys:function(t){return Promise.resolve(Object.keys(localStorage)).then((function(e){return t&&t(null,e),e})).catch((function(e){return t&&t(e,null),e}))},removeItem:function(t,e){return s.multiRemove([t]).then((function(){e&&e(null)})).catch((function(t){e&&e(t,null)}))},clear:function(){return new Promise((function(t){window.localStorage.clear(),t()}))},mergeItem:function(t,e){return s.multiMerge([[t,e]])},multiGet:function(t){return new Promise((function(e){e(t.reduce((function(t,e){return t.concat([[e,localStorage.getItem(e)]])}),[]))}))},multiSet:function(t){return new Promise((function(e,n){var r=[];return t.forEach((function(t){var e=o(t,2),n=e[0],i=e[1];try{localStorage.setItem(n,i)}catch(t){r.push(t)}})),r.length>0?n(r):e()}))},multiMerge:function(t){return new Promise((function(e,n){var r=[];return t.forEach((function(t){var e=o(t,2),n=e[0],i=e[1],s=localStorage.getItem(n);if(s)try{localStorage.setItem(n,JSON.stringify((0,a.default)(JSON.parse(s),JSON.parse(i))))}catch(t){r.push(t)}})),r.length>0?n(r):e()}))},multiRemove:function(t){return new Promise((function(e){t.forEach((function(t){return window.localStorage.removeItem(t)})),e()}))},flushGetRequests:function(){console.warn("AsyncStorage.flushGetRequests: Not supported on `web`")}},l=n.default=s,u=function(){return u=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},u.apply(this,arguments)};function c(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}var f,h,v=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){if(e.constructor!==n.constructor)return!1;var r,i,o;if(Array.isArray(e)){if((r=e.length)!=n.length)return!1;for(i=r;0!=i--;)if(!t(e[i],n[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if((r=(o=Object.keys(e)).length)!==Object.keys(n).length)return!1;for(i=r;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,o[i]))return!1;for(i=r;0!=i--;){var a=o[i];if(!t(e[a],n[a]))return!1}return!0}return e!=e&&n!=n},g=null,p="BULLET_TRAIN_DB",d="BULLET_TRAIN_EVENT",y="https://edge.api.flagsmith.com/api/v1/",_=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},m=function(){function t(t){var e=this;this.eventSource=null,this.getJSON=function(t,n,r){var i=e,o=i.environmentID,a=i.headers,s={method:n||"GET",body:r,headers:{"x-environment-key":"".concat(o)}};return n&&"GET"!==n&&(s.headers["Content-Type"]="application/json; charset=utf-8"),a&&Object.assign(s.headers,a),f||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR."),f(t,s).then((function(r){return e.log("Fetch response: "+r.status+" "+(n||"GET")+0+t),r.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return r.ok?e:Promise.reject(e)}))})).catch((function(t){console.error("Flagsmith: Fetch error: "+t)}))},this.getFlags=function(t,n){var r=e,i=r.onChange,o=r.onError,a=r.identity,s=r.api,l=!1;e.log("Get Flags");var c=function(t){var n=t.flags,r=t.traits;a&&(e.withTraits=null);var o={},s={};r=r||[],(n=n||[]).forEach((function(t){o[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),r.forEach((function(t){s[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),e.oldFlags=u({},e.flags);var l=v(e.flags,o),c=v(e.traits,s);if(e.flags=o,e.traits=s,e.updateStorage(),e.dtrum){var f={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(e.flags).map((function(t){O(f,"flagsmith_value_"+t,e.getValue(t)),O(f,"flagsmith_enabled_"+t,e.hasFeature(t))})),Object.keys(e.traits).map((function(t){O(f,"flagsmith_trait_"+t,e.getTrait(t))})),e.log("Sending javaLongOrObject traits to dynatrace",f.javaLongOrObject),e.log("Sending date traits to dynatrace",f.date),e.log("Sending shortString traits to dynatrace",f.shortString),e.log("Sending javaDouble to dynatrace",f.javaDouble),e.dtrum.sendSessionProperties(f.javaLongOrObject,f.date,f.shortString,f.javaDouble)}e.trigger&&e.trigger(),i&&i(e.oldFlags,{isFromServer:!0,flagsChanged:!l,traitsChanged:!c})};return a?Promise.all([e.withTraits?e.getJSON(s+"identities/","POST",JSON.stringify({identifier:a,traits:Object.keys(e.withTraits).map((function(t){return{trait_key:t,trait_value:e.withTraits[t]}}))})):e.getJSON(s+"identities/?identifier="+encodeURIComponent(a))]).then((function(n){e.withTraits=null,c(n[0]),t&&!l&&(l=!0,t())})).catch((function(t){var e=t.message;o&&o({message:e})})):Promise.all([e.getJSON(s+"flags/")]).then((function(e){c({flags:e[0],traits:void 0}),t&&!l&&(l=!0,t())})).catch((function(t){n&&!l&&(l=!0,n(t)),o&&o(t)}))},this.analyticsFlags=function(){var t=e.api;if(e.evaluationEvent&&0!==Object.getOwnPropertyNames(e.evaluationEvent).length&&0!==Object.getOwnPropertyNames(e.evaluationEvent[e.environmentID]).length)return e.getJSON(t+"analytics/flags/","POST",JSON.stringify(e.evaluationEvent[e.environmentID])).then((function(t){var n=e.getState();e.evaluationEvent||(e.evaluationEvent={}),e.evaluationEvent[e.environmentID]={},e.setState(u(u({},n),{evaluationEvent:e.evaluationEvent})),e.updateEventStorage()})).catch((function(t){e.log("Exception fetching evaluationEvent",t)}))},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(e.enableAnalytics){if(!e.evaluationEvent)return;e.evaluationEvent[e.environmentID]||(e.evaluationEvent[e.environmentID]={}),void 0===e.evaluationEvent[e.environmentID][t]&&(e.evaluationEvent[e.environmentID][t]=0),e.evaluationEvent[e.environmentID][t]+=1}e.updateEventStorage()},this.getValue=function(t,n){var r=e.flags&&e.flags[t.toLowerCase().replace(/ /g,"_")],i=null;if(r&&(i=r.value),e.evaluateFlag(t),null==n?void 0:n.json)try{return JSON.parse(i)}catch(t){return n.fallback}return i},this.getTrait=function(t){return e.traits&&e.traits[t.toLowerCase().replace(/ /g,"_")]},this.setTrait=function(t,n){var r=e,i=r.getJSON,o=r.identity,a=r.api;if(a){var s={};if(s[t]=n,!e.identity)return e.withTraits=u(u({},e.withTraits||{}),s),void e.log("Set trait prior to identifying",e.withTraits);var l={identity:{identifier:o},trait_key:t,trait_value:n};return i("".concat(a,"traits/"),"POST",JSON.stringify(l)).then((function(){e.initialised&&e.getFlags()}))}console.error(_("setTrait"))},this.setTraits=function(t){var n=e;n.getJSON;var r=n.identity,i=n.api;if(i)return t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),e.identity?e.getJSON(i+"identities/","POST",JSON.stringify({identifier:r,traits:Object.keys(t).map((function(e){return{trait_key:e,trait_value:t[e]}}))})).then((function(){e.initialised&&e.getFlags()})):(e.withTraits=u(u({},e.withTraits||{}),t),void e.log("Set traits prior to identifying",e.withTraits));console.error(_("setTraits"))},this.hasFeature=function(t){var n=e.flags&&e.flags[t.toLowerCase().replace(/ /g,"_")],r=!1;return n&&n.enabled&&(r=!0),e.evaluateFlag(t),r},f=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:null===global||void 0===global?void 0:global.fetch,this.canUseStorage="undefined"!=typeof window||!!t.browserlessStorage,this.log("Constructing flagsmith instance "+t),t.eventSource&&(h=t.eventSource),t.AsyncStorage&&(g=t.AsyncStorage)}return t.prototype.init=function(t){var e=this,n=t.environmentID,r=t.api,i=void 0===r?y:r,o=t.headers,a=t.onChange,s=t.cacheFlags,l=t.onError,c=t.defaultFlags,v=t.fetch,_=t.preventFetch,m=t.enableLogs,b=t.enableDynatrace,S=t.enableAnalytics,O=t.realtime,w=t.eventSourceUrl,j=void 0===w?"https://realtime.flagsmith.com/":w,E=t.AsyncStorage,I=t.identity,A=t.traits,F=t._trigger,T=t.state,C=t.cacheOptions,P=t.angularHttpClient;return new Promise((function(t,r){if(e.environmentID=n,e.api=i,e.headers=o,e.getFlagInterval=null,e.analyticsInterval=null,e.onChange=a,e.trigger=F,e.onError=l,e.identity=I,e.withTraits=A,e.enableLogs=m||!1,e.cacheOptions=C?{skipAPI:!!C.skipAPI,ttl:C.ttl||0}:e.cacheOptions,!e.cacheOptions.ttl&&e.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),v&&(f=v),e.enableAnalytics=S||!1,e.flags=Object.assign({},c)||{},e.initialised=!0,e.ticks=1e4,O&&"undefined"!=typeof window){var y=j+"sse/environments/"+n+"/stream";h?e.eventSource||(e.log("Creating event source with url "+y),e.eventSource=new h(y),e.eventSource.addEventListener("environment_updated",(function(t){e.log("Received eventsource message"),e.getFlags()}))):e.log("Error, EventSource is undefined")}if(e.log("Initialising with properties",{environmentID:n,api:i,headers:o,onChange:a,cacheFlags:s,onError:l,defaultFlags:c,preventFetch:_,enableLogs:m,enableAnalytics:S,AsyncStorage:g,identity:I,traits:A,_trigger:F,state:T,angularHttpClient:P},e),e.timer=e.enableLogs?(new Date).valueOf():null,E&&(g=E),e.cacheFlags=void 0!==g&&!!s,e.setState(T),!n)throw r("Please specify a environment id"),"Please specify a environment id";b&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):e.dtrum=dtrum),P&&(f=function(t,e){var n=e.headers,r=e.method,i=e.body;return new Promise((function(e){switch(r){case"GET":return P.get(t,{headers:n}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return P.post(t,i,{headers:n}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}))}}))}),g&&e.canUseStorage&&g.getItem(d).then((function(t){if(t)try{e.evaluationEvent=JSON.parse(t)}catch(t){e.evaluationEvent={}}else e.evaluationEvent={};return e.analyticsInterval=setInterval(e.analyticsFlags,e.ticks),!0})),e.enableAnalytics&&(e.analyticsInterval&&clearInterval(e.analyticsInterval),g&&e.canUseStorage&&g.getItem(d,(function(t,n){if(n){var r=JSON.parse(n);r[e.environmentID]&&(T=e.getState(),e.log("Retrieved events from cache",n),e.setState(u(u({},T),{evaluationEvent:r[e.environmentID]})))}return!0}))),s?g&&e.canUseStorage&&g.getItem(p,(function(n,i){if(i)try{var o=JSON.parse(i),a=!1;if(o&&o.api===e.api&&o.environmentID===e.environmentID){var s=!0;e.cacheOptions.ttl&&(!o.ts||(new Date).valueOf()-o.ts>e.cacheOptions.ttl)&&o.ts&&(e.log("Ignoring cache, timestamp is too old ts:"+o.ts+" ttl: "+e.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-o.ts)+"ms"),s=!1),s&&(a=!0,e.setState(o),e.log("Retrieved flags from cache",o))}e.flags?(e.trigger&&e.trigger(),e.onChange&&e.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!e.traits}),e.oldFlags=e.flags,t(!0),e.cacheOptions.skipAPI&&a&&e.log("Skipping API, using cache"),_||e.cacheOptions.skipAPI&&a||e.getFlags()):_?t(!0):e.getFlags(t,r)}catch(t){e.log("Exception fetching cached logs",t)}else _?(c&&(e.trigger&&e.trigger(),e.onChange&&e.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!e.traits})),t(!0)):e.getFlags(t,r);return!0})):_?(c&&(e.trigger&&e.trigger(),e.onChange&&e.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!e.traits})),t(!0)):e.getFlags(t,r)})).catch((function(t){e.log("Error during initialisation ",t),l&&l(t)}))},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,e){return this.identity=t,this.log("Identify: "+this.identity),e&&(this.withTraits=u(u({},this.withTraits||{}),e)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||y,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent)},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,c(["FLAGSMITH:",(new Date).valueOf()-(this.timer||0),"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),g.setItem(p,t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),g.setItem(d,t)}},t.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},t.prototype.getSegments=function(){},t}();function b(t){var e=t.fetch;t.browserlessStorage;var n=t.AsyncStorage,r=t.eventSource;return new m({fetch:e,AsyncStorage:n,eventSource:r})}var S,O=function(t,e,n){var r="shortString",i=!0;"number"==typeof n&&(r="javaDouble",i=!1),t[r]=t[r]||{},t[r][e]=i?n+"":n},w=(S=function(t,e){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},S(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}S(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),j=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},E=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a},I=function(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))},A=function(t){function e(){return t.call(this,"EventSource not available.\nConsider loading an EventSource polyfill and making it available globally as EventSource, or passing one in as eventSourceClass to the ReconnectingEventSource constructor.")||this}return w(e,t),e}(Error),F=function(){function t(t,e){var n=this;if(this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this._configuration=null!=e?Object.assign({},e):void 0,this.withCredentials=!1,this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={open:[],error:[],message:[]},this.url=t.toString(),this.readyState=this.CONNECTING,this.max_retry_time=3e3,this.eventSourceClass=globalThis.EventSource,null!=this._configuration&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time),this._configuration.eventSourceClass&&(this.eventSourceClass=this._configuration.eventSourceClass,delete this._configuration.eventSourceClass)),null==this.eventSourceClass||"function"!=typeof this.eventSourceClass)throw new A;this._onevent_wrapped=function(t){n._onevent(t)},this._start()}return t.prototype.dispatchEvent=function(t){throw new Error("Method not implemented.")},t.prototype._start=function(){var t,e,n=this,r=this.url;this._lastEventId&&(-1===r.indexOf("?")?r+="?":r+="&",r+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new this.eventSourceClass(r,this._configuration),this._eventSource.onopen=function(t){n._onopen(t)},this._eventSource.onerror=function(t){n._onerror(t)},this._eventSource.onmessage=function(t){n.onmessage(t)};try{for(var i=j(Object.keys(this._listeners)),o=i.next();!o.done;o=i.next()){var a=o.value;this._eventSource.addEventListener(a,this._onevent_wrapped)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},t.prototype._onopen=function(t){0===this.readyState&&(this.readyState=1,this.onopen(t))},t.prototype._onerror=function(t){var e=this;if(1===this.readyState&&(this.readyState=0,this.onerror(t)),this._eventSource&&2===this._eventSource.readyState){this._eventSource.close(),this._eventSource=null;var n=Math.round(this.max_retry_time*Math.random());this._timer=setTimeout((function(){return e._start()}),n)}},t.prototype._onevent=function(t){var e,n;t instanceof MessageEvent&&(this._lastEventId=t.lastEventId);var r=this._listeners[t.type];if(null!=r)try{for(var i=j(I([],E(r),!1)),o=i.next();!o.done;o=i.next()){o.value.call(this,t)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}"message"===t.type&&this.onmessage(t)},t.prototype.onopen=function(t){},t.prototype.onerror=function(t){},t.prototype.onmessage=function(t){},t.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2},t.prototype.addEventListener=function(t,e,n){null==this._listeners[t]&&(this._listeners[t]=[],null!=this._eventSource&&this._eventSource.addEventListener(t,this._onevent_wrapped));var r=this._listeners[t];r.includes(e)||(this._listeners[t]=I(I([],E(r),!1),[e],!1))},t.prototype.removeEventListener=function(t,e,n){var r=this._listeners[t];this._listeners[t]=r.filter((function(t){return t!==e}))},t}(),T=function(t,e){return e=e||{},new Promise((function(n,r){var i=new XMLHttpRequest,o=[],a=[],s={},l=function(){return{ok:2==(i.status/100|0),statusText:i.statusText,status:i.status,url:i.responseURL,text:function(){return Promise.resolve(i.responseText)},json:function(){return Promise.resolve(i.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([i.response]))},clone:l,headers:{keys:function(){return o},entries:function(){return a},get:function(t){return s[t.toLowerCase()]},has:function(t){return t.toLowerCase()in s}}}};for(var u in i.open(e.method||"get",t,!0),i.onload=function(){i.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,(function(t,e,n){o.push(e=e.toLowerCase()),a.push([e,n]),s[e]=s[e]?s[e]+","+n:n})),n(l())},i.onerror=r,i.withCredentials="include"==e.credentials,e.headers)i.setRequestHeader(u,e.headers[u]);i.send(e.body||null)}))},C=b({AsyncStorage:l,fetch:T,eventSource:F});"undefined"!=typeof window&&(window.flagsmith=C);t.createFlagsmithInstance=function(){return b({AsyncStorage:l,fetch:T,eventSource:F})},t.default=C,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
