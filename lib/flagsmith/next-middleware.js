!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["next-middleware"]={})}(this,(function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,n=1,a=arguments.length;n<a;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},e.apply(this,arguments)};function n(t,e,n){if(n||2===arguments.length)for(var a,i=0,r=e.length;i<r;i++)!a&&i in e||(a||(a=Array.prototype.slice.call(e,0,i)),a[i]=e[i]);return t.concat(a||Array.prototype.slice.call(e))}var a,i,r=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){if(e.constructor!==n.constructor)return!1;var a,i,r;if(Array.isArray(e)){if((a=e.length)!=n.length)return!1;for(i=a;0!=i--;)if(!t(e[i],n[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if((a=(r=Object.keys(e)).length)!==Object.keys(n).length)return!1;for(i=a;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,r[i]))return!1;for(i=a;0!=i--;){var s=r[i];if(!t(e[s],n[s]))return!1}return!0}return e!=e&&n!=n},s=null,o="BULLET_TRAIN_DB",l="BULLET_TRAIN_EVENT",g="https://edge.api.flagsmith.com/api/v1/",c=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},u=function(){function t(t){var n=this;this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getJSON=function(t,e,i){var r=n,s=r.environmentID,o=r.headers,l={method:e||"GET",body:i,headers:{"x-environment-key":"".concat(s)}};return e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),a||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR."),a(t,l).then((function(a){var i,r=null===(i=a.headers)||void 0===i?void 0:i.get("x-flagsmith-document-updated-at");if(r)try{var s=parseFloat(r);if(isNaN(s))throw"Failed to parse x-flagsmith-document-updated-at";n.timestamp=s}catch(t){n.log(t,"Failed to parse x-flagsmith-document-updated-at",r)}return n.log("Fetch response: "+a.status+" "+(e||"GET")+0+t),a.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return a.status&&a.status>=200&&a.status<300?e:Promise.reject(e)}))})).catch((function(t){throw console.error("Flagsmith: Fetch error: "+t),new Error("Flagsmith: Fetch error:"+t)}))},this.getFlags=function(t,a){var i=n,s=i.onChange,o=i.onError,l=i.identity,g=i.api,c=!1;n.log("Get Flags"),n.isLoading=!0;var u=function(t){var a=t.flags,i=t.traits;n.isLoading=!1,l&&(n.withTraits=null);var o={},g={};i=i||[],(a=a||[]).forEach((function(t){o[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),i.forEach((function(t){g[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),n.oldFlags=e({},n.flags);var c=r(n.flags,o),u=r(n.traits,g);if(n.flags=o,n.traits=g,n.updateStorage(),n.dtrum){var h={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(n.flags).map((function(t){f(h,"flagsmith_value_"+t,n.getValue(t)),f(h,"flagsmith_enabled_"+t,n.hasFeature(t))})),Object.keys(n.traits).map((function(t){f(h,"flagsmith_trait_"+t,n.getTrait(t))})),n.log("Sending javaLongOrObject traits to dynatrace",h.javaLongOrObject),n.log("Sending date traits to dynatrace",h.date),n.log("Sending shortString traits to dynatrace",h.shortString),n.log("Sending javaDouble to dynatrace",h.javaDouble),n.dtrum.sendSessionProperties(h.javaLongOrObject,h.date,h.shortString,h.javaDouble)}n.trigger&&(n.log("trigger called"),n.trigger()),s&&s(n.oldFlags,{isFromServer:!0,flagsChanged:!c,traitsChanged:!u})};return l?Promise.all([n.withTraits?n.getJSON(g+"identities/","POST",JSON.stringify({identifier:l,traits:Object.keys(n.withTraits).map((function(t){return{trait_key:t,trait_value:n.withTraits[t]}}))})):n.getJSON(g+"identities/?identifier="+encodeURIComponent(l))]).then((function(e){n.withTraits=null,u(e[0]),t&&!c&&(c=!0,t())})).catch((function(t){var e=t.message;n.isLoading=!1,o&&o({message:e})})):Promise.all([n.getJSON(g+"flags/")]).then((function(e){u({flags:e[0],traits:void 0}),t&&!c&&(c=!0,t())})).catch((function(t){n.isLoading=!1,a&&!c&&(c=!0,a(t)),o&&o(t)}))},this.analyticsFlags=function(){var t=n.api;if(n.evaluationEvent&&n.evaluationEvent[n.environmentID])return n.evaluationEvent&&0!==Object.getOwnPropertyNames(n.evaluationEvent).length&&0!==Object.getOwnPropertyNames(n.evaluationEvent[n.environmentID]).length?n.getJSON(t+"analytics/flags/","POST",JSON.stringify(n.evaluationEvent[n.environmentID])).then((function(t){var a=n.getState();n.evaluationEvent||(n.evaluationEvent={}),n.evaluationEvent[n.environmentID]={},n.setState(e(e({},a),{evaluationEvent:n.evaluationEvent})),n.updateEventStorage()})).catch((function(t){n.log("Exception fetching evaluationEvent",t)})):void 0},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(n.enableAnalytics){if(!n.evaluationEvent)return;n.evaluationEvent[n.environmentID]||(n.evaluationEvent[n.environmentID]={}),void 0===n.evaluationEvent[n.environmentID][t]&&(n.evaluationEvent[n.environmentID][t]=0),n.evaluationEvent[n.environmentID][t]+=1}n.updateEventStorage()},this.getValue=function(t,e){var a=n.flags&&n.flags[t.toLowerCase().replace(/ /g,"_")],i=null;if(a&&(i=a.value),n.evaluateFlag(t),null==e?void 0:e.json)try{return null===i?(n.log("Tried to parse null flag as JSON: "+t),e.fallback):JSON.parse(i)}catch(t){return e.fallback}return i},this.getTrait=function(t){return n.traits&&n.traits[t.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return n.traits},this.setTrait=function(t,e){if(n.api){var a={};return a[t]=e,n.setTraits(a)}console.error(c("setTrait"))},this.setTraits=function(t){if(n.api){if(t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),n.withTraits=e(e({},n.withTraits||{}),t),n.identity)return n.initialised?n.getFlags():void 0;n.log("Set traits prior to identifying",n.withTraits)}else console.error(c("setTraits"))},this.hasFeature=function(t){var e=n.flags&&n.flags[t.toLowerCase().replace(/ /g,"_")],a=!1;return e&&e.enabled&&(a=!0),n.evaluateFlag(t),a},a=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:null===global||void 0===global?void 0:global.fetch,this.canUseStorage="undefined"!=typeof window||!!t.browserlessStorage,this.log("Constructing flagsmith instance "+t),t.eventSource&&(i=t.eventSource),t.AsyncStorage&&(s=t.AsyncStorage)}return t.prototype.init=function(t){var n=this,r=t.environmentID,c=t.api,u=void 0===c?g:c,h=t.headers,f=t.onChange,v=t.cacheFlags,d=t.onError,p=t.defaultFlags,m=t.fetch,y=t.preventFetch,S=t.enableLogs,b=t.enableDynatrace,O=t.enableAnalytics,I=t.realtime,E=t.eventSourceUrl,F=void 0===E?"https://realtime.flagsmith.com/":E,w=t.AsyncStorage,T=t.identity,j=t.traits,D=t._trigger,C=t.state,A=t.cacheOptions,_=t.angularHttpClient;return new Promise((function(t,g){if(n.environmentID=r,n.api=u,n.headers=h,n.getFlagInterval=null,n.analyticsInterval=null,n.onChange=f,n.trigger=D||n.trigger,n.onError=d?function(t){t instanceof Error?d(t):d(new Error(t))}:null,n.identity=T,n.withTraits=j,n.enableLogs=S||!1,n.cacheOptions=A?{skipAPI:!!A.skipAPI,ttl:A.ttl||0}:n.cacheOptions,!n.cacheOptions.ttl&&n.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),m&&(a=m),n.enableAnalytics=O||!1,n.flags=Object.assign({},p)||{},n.initialised=!0,n.ticks=1e4,I&&"undefined"!=typeof window){var c=F+"sse/environments/"+r+"/stream";i?n.eventSource||(n.log("Creating event source with url "+c),n.eventSource=new i(c),n.eventSource.addEventListener("environment_updated",(function(t){var e,a;try{a=JSON.parse(t.data).updated_at}catch(t){n.log("Could not parse sse event",t)}a?!n.timestamp||(null===(e=t.data)||void 0===e?void 0:e.updated_at)>n.timestamp?n.isLoading?n.log("updated_at is new, but flags are loading",t.data,n.timestamp):(n.log("updated_at is new, fetching flags",t.data,n.timestamp),n.getFlags()):n.log("updated_at is outdated, skipping get flags",t.data,n.timestamp):n.log("No updated_at received, fetching flags",t)}))):n.log("Error, EventSource is undefined")}if(n.log("Initialising with properties",{environmentID:r,api:u,headers:h,onChange:f,cacheFlags:v,onError:d,defaultFlags:p,preventFetch:y,enableLogs:S,enableAnalytics:O,AsyncStorage:s,identity:T,traits:j,_trigger:D,state:C,angularHttpClient:_},n),n.timer=n.enableLogs?(new Date).valueOf():null,w&&(s=w),n.cacheFlags=void 0!==s&&!!v,n.setState(C),!r)throw g("Please specify a environment id"),"Please specify a environment id";b&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):n.dtrum=dtrum),_&&(a=function(t,e){var n=e.headers,a=e.method,i=e.body;return new Promise((function(e){switch(a){case"GET":return _.get(t,{headers:n}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return _.post(t,i,{headers:n}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}))}}))}),s&&n.canUseStorage&&s.getItem(l).then((function(t){if(t)try{n.evaluationEvent=JSON.parse(t)}catch(t){n.evaluationEvent={}}else n.evaluationEvent={};return n.analyticsInterval=setInterval(n.analyticsFlags,n.ticks),!0})),n.enableAnalytics&&(n.analyticsInterval&&clearInterval(n.analyticsInterval),s&&n.canUseStorage&&s.getItem(l,(function(t,a){if(a){var i=JSON.parse(a);i[n.environmentID]&&(C=n.getState(),n.log("Retrieved events from cache",a),n.setState(e(e({},C),{evaluationEvent:i[n.environmentID]})))}return!0}))),v?s&&n.canUseStorage&&s.getItem(o,(function(e,a){if(a)try{var i=JSON.parse(a),r=!1;if(i&&i.api===n.api&&i.environmentID===n.environmentID){var s=!0;n.identity&&i.identity!==n.identity&&(n.log("Ignoring cache,  identity has changed from "+i.identity+" to "+n.identity),s=!1),n.cacheOptions.ttl&&(!i.ts||(new Date).valueOf()-i.ts>n.cacheOptions.ttl)&&i.ts&&(n.log("Ignoring cache, timestamp is too old ts:"+i.ts+" ttl: "+n.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-i.ts)+"ms"),s=!1),s&&(r=!0,n.setState(i),n.log("Retrieved flags from cache",i))}n.flags?(n.trigger&&(n.log("trigger called"),n.trigger()),n.onChange&&(n.log("onChange called"),n.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!n.traits})),n.oldFlags=n.flags,t(!0),n.cacheOptions.skipAPI&&r&&n.log("Skipping API, using cache"),y||n.cacheOptions.skipAPI&&r||n.getFlags()):y?t(!0):n.getFlags(t,g)}catch(t){n.log("Exception fetching cached logs",t)}else y?(p&&(n.trigger&&(n.log("trigger called"),n.trigger()),n.onChange&&(n.log("onChange called"),n.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!n.traits}))),t(!0)):n.getFlags(t,g);return!0})):y?(p&&(n.trigger&&(n.log("trigger called"),n.trigger()),n.onChange&&(n.log("onChange called"),n.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!n.traits}))),t(!0)):n.getFlags(t,g)})).catch((function(t){n.log("Error during initialisation ",t),d&&d(t)}))},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,n){return this.identity=t,this.log("Identify: "+this.identity),n&&(this.withTraits=e(e({},this.withTraits||{}),n)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||g,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,n(["FLAGSMITH:",(new Date).valueOf()-(this.timer||0),"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),s.setItem(o,t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),s.setItem(l,t)}},t.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},t.prototype.getSegments=function(){},t}();function h(t){var e=t.fetch;t.browserlessStorage;var n=t.AsyncStorage,a=t.eventSource;return new u({fetch:e,AsyncStorage:n,eventSource:a})}var f=function(t,e,n){var a="shortString",i=!0;"number"==typeof n&&(a="javaDouble",i=!1),t[a]=t[a]||{},t[a][e]=i?n+"":n},v=h({});t.createFlagsmithInstance=function(){return h({})},t.default=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=next-middleware.js.map
