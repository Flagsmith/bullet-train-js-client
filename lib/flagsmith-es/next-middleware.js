var t=function(){return t=Object.assign||function(t){for(var e,a=1,n=arguments.length;a<n;a++)for(var i in e=arguments[a])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},t.apply(this,arguments)};function e(t,e,a){if(a||2===arguments.length)for(var n,i=0,r=e.length;i<r;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))}var a,n,i=function t(e,a){if(e===a)return!0;if(e&&a&&"object"==typeof e&&"object"==typeof a){if(e.constructor!==a.constructor)return!1;var n,i,r;if(Array.isArray(e)){if((n=e.length)!=a.length)return!1;for(i=n;0!=i--;)if(!t(e[i],a[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===a.source&&e.flags===a.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===a.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===a.toString();if((n=(r=Object.keys(e)).length)!==Object.keys(a).length)return!1;for(i=n;0!=i--;)if(!Object.prototype.hasOwnProperty.call(a,r[i]))return!1;for(i=n;0!=i--;){var o=r[i];if(!t(e[o],a[o]))return!1}return!0}return e!=e&&a!=a};!function(t){t.NONE="NONE",t.DEFAULT_FLAGS="DEFAULT_FLAGS",t.CACHE="CACHE",t.SERVER="SERVER"}(a||(a={}));var r,o=null,s="https://edge.api.flagsmith.com/api/v1/",l=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},g=function(){function g(e){var s=this;this._trigger=null,this._triggerLoadingState=null,this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getJSON=function(t,e,a){var i=s,r=i.environmentID,o=i.headers,l={method:e||"GET",body:a,headers:{"x-environment-key":"".concat(r)}};return e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),n||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR."),n(t,l).then((function(a){var n,i=null===(n=a.headers)||void 0===n?void 0:n.get("x-flagsmith-document-updated-at");if(i)try{var r=parseFloat(i);if(isNaN(r))throw"Failed to parse x-flagsmith-document-updated-at";s.timestamp=r}catch(t){s.log(t,"Failed to parse x-flagsmith-document-updated-at",i)}return s.log("Fetch response: "+a.status+" "+(e||"GET")+0+t),a.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return a.status&&a.status>=200&&a.status<300?e:Promise.reject(e)}))})).catch((function(t){throw console.error("Flagsmith: Fetch error: "+t),new Error("Flagsmith: Fetch error:"+t)}))},this.getFlags=function(e,n){var r=s,o=r.onChange,l=r.onError,g=r.identity,u=r.api,h=!1;s.log("Get Flags"),s.isLoading=!0,s.loadingState.isFetching||s.setLoadingState(t(t({},s.loadingState),{isFetching:!0}));var d=function(e){var n=e.flags,r=e.traits;s.isLoading=!1,g&&(s.withTraits=null);var l={},u={};r=r||[],(n=n||[]).forEach((function(t){l[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),r.forEach((function(t){u[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),s.oldFlags=t({},s.flags);var h=i(s.flags,l),d=i(s.traits,u);if(s.flags=l,s.traits=u,s.updateStorage(),s.datadogRum)try{if(s.datadogRum.trackTraits){var v={};Object.keys(s.traits).map((function(t){v["flagsmith_trait_"+t]=s.getTrait(t)}));var f=t(t(t({},s.datadogRum.client.getUser()),{id:s.datadogRum.client.getUser().id||s.identity}),v);s.log("Setting Datadog user",f),s.datadogRum.client.setUser(f)}}catch(t){console.error(t)}if(s.dtrum)try{var p={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(s.flags).map((function(t){c(p,"flagsmith_value_"+t,s.getValue(t,{},!0)),c(p,"flagsmith_enabled_"+t,s.hasFeature(t,!0))})),Object.keys(s.traits).map((function(t){c(p,"flagsmith_trait_"+t,s.getTrait(t))})),s.log("Sending javaLongOrObject traits to dynatrace",p.javaLongOrObject),s.log("Sending date traits to dynatrace",p.date),s.log("Sending shortString traits to dynatrace",p.shortString),s.log("Sending javaDouble to dynatrace",p.javaDouble),s.dtrum.sendSessionProperties(p.javaLongOrObject,p.date,p.shortString,p.javaDouble)}catch(t){console.error(t)}o&&o(s.oldFlags,{isFromServer:!0,flagsChanged:!h,traitsChanged:!d},s._loadedState(a.SERVER))};return g?Promise.all([s.withTraits?s.getJSON(u+"identities/","POST",JSON.stringify({identifier:g,traits:Object.keys(s.withTraits).map((function(t){return{trait_key:t,trait_value:s.withTraits[t]}}))})):s.getJSON(u+"identities/?identifier="+encodeURIComponent(g))]).then((function(t){s.withTraits=null,d(t[0]),e&&!h&&(h=!0,e())})).catch((function(t){var e=t.message;s.isLoading=!1,l&&l(new Error(e))})):Promise.all([s.getJSON(u+"flags/")]).then((function(t){d({flags:t[0],traits:void 0}),e&&!h&&(h=!0,e())})).catch((function(t){s.isLoading=!1,n&&!h&&(h=!0,n(t)),l&&l(t)}))},this.analyticsFlags=function(){var e=s.api;if(s.evaluationEvent&&s.evaluationEvent[s.environmentID])return s.evaluationEvent&&0!==Object.getOwnPropertyNames(s.evaluationEvent).length&&0!==Object.getOwnPropertyNames(s.evaluationEvent[s.environmentID]).length?s.getJSON(e+"analytics/flags/","POST",JSON.stringify(s.evaluationEvent[s.environmentID])).then((function(e){var a=s.getState();s.evaluationEvent||(s.evaluationEvent={}),s.evaluationEvent[s.environmentID]={},s.setState(t(t({},a),{evaluationEvent:s.evaluationEvent})),s.updateEventStorage()})).catch((function(t){s.log("Exception fetching evaluationEvent",t)})):void 0},this.datadogRum=null,this.loadingState={isLoading:!0,isFetching:!0,error:null,source:a.NONE},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t,e){if(s.datadogRum&&(s.datadogRum.client.addFeatureFlagEvaluation?(s.log("Sending feature flag evaluation to Datadog",t,e),"VALUE"===e?s.datadogRum.client.addFeatureFlagEvaluation("flagsmith_value_"+t,s.getValue(t,{},!0)):s.datadogRum.client.addFeatureFlagEvaluation("flagsmith_enabled_"+t,s.hasFeature(t,!0))):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")),s.enableAnalytics){if(!s.evaluationEvent)return;s.evaluationEvent[s.environmentID]||(s.evaluationEvent[s.environmentID]={}),void 0===s.evaluationEvent[s.environmentID][t]&&(s.evaluationEvent[s.environmentID][t]=0),s.evaluationEvent[s.environmentID][t]+=1}s.updateEventStorage()},this.getValue=function(t,e,a){var n=s.flags&&s.flags[t.toLowerCase().replace(/ /g,"_")],i=null;if(n&&(i=n.value),a||s.evaluateFlag(t,"VALUE"),null==e?void 0:e.json)try{return null===i?(s.log("Tried to parse null flag as JSON: "+t),e.fallback):JSON.parse(i)}catch(t){return e.fallback}return i},this.getTrait=function(t){return s.traits&&s.traits[t.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return s.traits},this.setTrait=function(t,e){if(s.api){var a={};return a[t]=e,s.setTraits(a)}console.error(l("setTrait"))},this.setTraits=function(e){if(s.api){if(e&&"object"==typeof e||console.error("Expected object for flagsmith.setTraits"),s.withTraits=t(t({},s.withTraits||{}),e),s.identity)return s.initialised?s.getFlags():void 0;s.log("Set traits prior to identifying",s.withTraits)}else console.error(l("setTraits"))},this.hasFeature=function(t,e){var a=s.flags&&s.flags[t.toLowerCase().replace(/ /g,"_")],n=!1;return a&&a.enabled&&(n=!0),e||s.evaluateFlag(t,"ENABLED"),n},n=e.fetch?e.fetch:"undefined"!=typeof fetch?fetch:null===global||void 0===global?void 0:global.fetch,this.canUseStorage="undefined"!=typeof window||!!e.browserlessStorage,this.log("Constructing flagsmith instance "+e),e.eventSource&&(r=e.eventSource),e.AsyncStorage&&(o=e.AsyncStorage)}return g.prototype.init=function(e){var i=this,l=e.environmentID,g=e.api,u=void 0===g?s:g,c=e.headers,h=e.onChange,d=e.cacheFlags,v=e.datadogRum,f=e.onError,p=e.defaultFlags,m=e.fetch,y=e.preventFetch,S=e.enableLogs,E=e.enableDynatrace,F=e.enableAnalytics,O=e.realtime,I=e.eventSourceUrl,b=void 0===I?"https://realtime.flagsmith.com/":I,_=e.AsyncStorage,L=e.identity,A=e.traits,T=e.state,w=e.cacheOptions,D=e.angularHttpClient,C=e._trigger;return e._triggerLoadingStateChange,new Promise((function(e,s){var g;if(i.environmentID=l,i.api=u,i.headers=c,i.getFlagInterval=null,i.analyticsInterval=null,i.onChange=function(t,e,a){h&&h(t,e,i.loadingState),i._trigger&&(i.log("trigger called"),i._trigger()),i.setLoadingState(a)},i._trigger=C||i._trigger,i.onError=f?function(t){t instanceof Error?f(t):f(new Error(t))}:null,i.identity=L,i.withTraits=A,i.enableLogs=S||!1,i.cacheOptions=w?{skipAPI:!!w.skipAPI,ttl:w.ttl||0}:i.cacheOptions,!i.cacheOptions.ttl&&i.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),m&&(n=m),i.enableAnalytics=F||!1,i.flags=Object.assign({},p)||{},i.initialised=!0,i.ticks=1e4,Object.keys(i.flags).length&&(i.loadingState=t(t({},i.loadingState),{isLoading:!1,source:a.DEFAULT_FLAGS})),O&&"undefined"!=typeof window){var I=b+"sse/environments/"+l+"/stream";r?i.eventSource||(i.log("Creating event source with url "+I),i.eventSource=new r(I),i.eventSource.addEventListener("environment_updated",(function(t){var e;try{e=JSON.parse(t.data).updated_at}catch(t){i.log("Could not parse sse event",t)}e?!i.timestamp||e>i.timestamp?i.isLoading?i.log("updated_at is new, but flags are loading",t.data,i.timestamp):(i.log("updated_at is new, fetching flags",t.data,i.timestamp),i.getFlags()):i.log("updated_at is outdated, skipping get flags",t.data,i.timestamp):i.log("No updated_at received, fetching flags",t)}))):i.log("Error, EventSource is undefined")}if(i.log("Initialising with properties",{environmentID:l,api:u,headers:c,onChange:h,cacheFlags:d,onError:f,defaultFlags:p,preventFetch:y,enableLogs:S,enableAnalytics:F,AsyncStorage:o,identity:L,traits:A,_trigger:C,state:T,angularHttpClient:D},i),i.timer=i.enableLogs?(new Date).valueOf():null,_&&(o=_),i.cacheFlags=void 0!==o&&!!d,i.setState(T),!l)throw s("Please specify a environment id"),"Please specify a environment id";v&&(i.datadogRum=v),E&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):i.dtrum=dtrum),D&&(n=function(t,e){var a=e.headers,n=e.method,i=e.body;return new Promise((function(e){switch(n){case"GET":return D.get(t,{headers:a}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return D.post(t,i,{headers:a}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}))}}))}),o&&i.canUseStorage&&o.getItem("BULLET_TRAIN_EVENT").then((function(t){if(t)try{i.evaluationEvent=JSON.parse(t)}catch(t){i.evaluationEvent={}}else i.evaluationEvent={};return i.analyticsInterval=setInterval(i.analyticsFlags,i.ticks),!0})),i.enableAnalytics&&(i.analyticsInterval&&clearInterval(i.analyticsInterval),o&&i.canUseStorage&&o.getItem("BULLET_TRAIN_EVENT",(function(e,a){if(a){var n=JSON.parse(a);n[i.environmentID]&&(T=i.getState(),i.log("Retrieved events from cache",a),i.setState(t(t({},T),{evaluationEvent:n[i.environmentID]})))}return!0}))),d?o&&i.canUseStorage&&o.getItem("BULLET_TRAIN_DB",(function(t,n){var r,o;if(n)try{var l=JSON.parse(n),g=!1;if(l&&l.api===i.api&&l.environmentID===i.environmentID){var u=!0;i.identity&&l.identity!==i.identity&&(i.log("Ignoring cache,  identity has changed from "+l.identity+" to "+i.identity),u=!1),i.cacheOptions.ttl&&(!l.ts||(new Date).valueOf()-l.ts>i.cacheOptions.ttl)&&l.ts&&(i.log("Ignoring cache, timestamp is too old ts:"+l.ts+" ttl: "+i.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-l.ts)+"ms"),u=!1),u&&(g=!0,i.setState(l),i.log("Retrieved flags from cache",l))}i.flags?(null===(r=i.onChange)||void 0===r||r.call(i,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!i.traits},i._loadedState(a.CACHE)),i.oldFlags=i.flags,e(!0),i.cacheOptions.skipAPI&&g&&i.log("Skipping API, using cache"),y||i.cacheOptions.skipAPI&&g||i.getFlags()):y?e(!0):i.getFlags(e,s)}catch(t){i.log("Exception fetching cached logs",t)}else y?(p&&(null===(o=i.onChange)||void 0===o||o.call(i,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!i.traits},i._loadedState(a.DEFAULT_FLAGS))),e(!0)):i.getFlags(e,s);return!0})):y?(p&&(null===(g=i.onChange)||void 0===g||g.call(i,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!i.traits},i._loadedState(a.CACHE))),e(!0)):i.getFlags(e,s)})).catch((function(t){i.log("Error during initialisation ",t),f&&f(t)}))},g.prototype._loadedState=function(t){return{error:null,isFetching:!1,isLoading:!1,source:t}},g.prototype.getAllFlags=function(){return this.flags},g.prototype.identify=function(e,a){return this.identity=e,this.log("Identify: "+this.identity),a&&(this.withTraits=t(t({},this.withTraits||{}),a)),this.initialised?this.getFlags():Promise.resolve()},g.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},g.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||s,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},g.prototype.log=function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];this.enableLogs&&console.log.apply(this,e(["FLAGSMITH:",(new Date).valueOf()-(this.timer||0),"ms"],t,!0))},g.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),o.setItem("BULLET_TRAIN_DB",t)}},g.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),o.setItem("BULLET_TRAIN_EVENT",t)}},g.prototype.setLoadingState=function(t){var e;i(t,this.loadingState)||(this.loadingState=t,this.log("Loading state changed",t),null===(e=this._triggerLoadingState)||void 0===e||e.call(this))},g.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},g.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},g.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},g.prototype.getSegments=function(){},g}();function u(t){var e=t.fetch,a=t.AsyncStorage,n=t.eventSource;return new g({fetch:e,AsyncStorage:a,eventSource:n})}var c=function(t,e,a){var n="shortString",i=!0;"number"==typeof a&&(n="javaDouble",i=!1),t[n]=t[n]||{},t[n][e]=i?a+"":a},h=u({}),d=function(){return u({})};export{d as createFlagsmithInstance,h as default};
//# sourceMappingURL=next-middleware.js.map
