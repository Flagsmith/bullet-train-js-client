var t={};Object.defineProperty(t,"__esModule",{value:!0});var e,n=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},r={getItem:function(t,e){return r.multiGet([t]).then((function(t){return t[0][1]})).then((function(t){return e&&e(null,t),t})).catch((function(t){return e&&e(t,null),t}))},setItem:function(t,e,n){return r.multiSet([[t,e]]).then((function(t){return n&&n(null,t),t})).catch((function(t){return n&&n(t,null),t}))},getAllKeys:function(t){return Promise.resolve(Object.keys(localStorage)).then((function(e){return t&&t(null,e),e})).catch((function(e){return t&&t(e,null),e}))},removeItem:function(t,e){return r.multiRemove([t]).then((function(){e&&e(null)})).catch((function(t){e&&e(t,null)}))},clear:function(){return new Promise((function(t){window.localStorage.clear(),t()}))},multiGet:function(t){return new Promise((function(e){e(t.reduce((function(t,e){return t.concat([[e,localStorage.getItem(e)]])}),[]))}))},multiSet:function(t){return new Promise((function(e,r){var i=[];return t.forEach((function(t){var e=n(t,2),r=e[0],a=e[1];try{localStorage.setItem(r,a)}catch(t){i.push(t)}})),i.length>0?r(i):e()}))},multiRemove:function(t){return new Promise((function(e){t.forEach((function(t){return window.localStorage.removeItem(t)})),e()}))},flushGetRequests:function(){console.warn("AsyncStorage.flushGetRequests: Not supported on `web`")}},i=t.default=r,a=(e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},e(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}),o=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},s=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,a=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=a.next()).done;)o.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}return o},l=function(t,e,n){if(n||2===arguments.length)for(var r,i=0,a=e.length;i<a;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))},u=function(t){function e(){return t.call(this,"EventSource not available.\nConsider loading an EventSource polyfill and making it available globally as EventSource, or passing one in as eventSourceClass to the ReconnectingEventSource constructor.")||this}return a(e,t),e}(Error),c=function(){function t(t,e){var n=this;if(this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this._configuration=null!=e?Object.assign({},e):void 0,this.withCredentials=!1,this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={open:[],error:[],message:[]},this.url=t.toString(),this.readyState=this.CONNECTING,this.max_retry_time=3e3,this.eventSourceClass=globalThis.EventSource,null!=this._configuration&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time),this._configuration.eventSourceClass&&(this.eventSourceClass=this._configuration.eventSourceClass,delete this._configuration.eventSourceClass)),null==this.eventSourceClass||"function"!=typeof this.eventSourceClass)throw new u;this._onevent_wrapped=function(t){n._onevent(t)},this._start()}return t.prototype.dispatchEvent=function(t){throw new Error("Method not implemented.")},t.prototype._start=function(){var t,e,n=this,r=this.url;this._lastEventId&&(-1===r.indexOf("?")?r+="?":r+="&",r+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new this.eventSourceClass(r,this._configuration),this._eventSource.onopen=function(t){n._onopen(t)},this._eventSource.onerror=function(t){n._onerror(t)},this._eventSource.onmessage=function(t){n.onmessage(t)};try{for(var i=o(Object.keys(this._listeners)),a=i.next();!a.done;a=i.next()){var s=a.value;this._eventSource.addEventListener(s,this._onevent_wrapped)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},t.prototype._onopen=function(t){0===this.readyState&&(this.readyState=1,this.onopen(t))},t.prototype._onerror=function(t){var e=this;if(1===this.readyState&&(this.readyState=0,this.onerror(t)),this._eventSource&&2===this._eventSource.readyState){this._eventSource.close(),this._eventSource=null;var n=Math.round(this.max_retry_time*Math.random());this._timer=setTimeout((function(){return e._start()}),n)}},t.prototype._onevent=function(t){var e,n;t instanceof MessageEvent&&(this._lastEventId=t.lastEventId);var r=this._listeners[t.type];if(null!=r)try{for(var i=o(l([],s(r),!1)),a=i.next();!a.done;a=i.next()){a.value.call(this,t)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}"message"===t.type&&this.onmessage(t)},t.prototype.onopen=function(t){},t.prototype.onerror=function(t){},t.prototype.onmessage=function(t){},t.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2},t.prototype.addEventListener=function(t,e,n){null==this._listeners[t]&&(this._listeners[t]=[],null!=this._eventSource&&this._eventSource.addEventListener(t,this._onevent_wrapped));var r=this._listeners[t];r.includes(e)||(this._listeners[t]=l(l([],s(r),!1),[e],!1))},t.prototype.removeEventListener=function(t,e,n){var r=this._listeners[t];this._listeners[t]=r.filter((function(t){return t!==e}))},t}(),h=function(){return h=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},h.apply(this,arguments)};function g(t,e,n){if(n||2===arguments.length)for(var r,i=0,a=e.length;i<a;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}var f,v,d=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){if(e.constructor!==n.constructor)return!1;var r,i,a;if(Array.isArray(e)){if((r=e.length)!=n.length)return!1;for(i=r;0!=i--;)if(!t(e[i],n[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if((r=(a=Object.keys(e)).length)!==Object.keys(n).length)return!1;for(i=r;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,a[i]))return!1;for(i=r;0!=i--;){var o=a[i];if(!t(e[o],n[o]))return!1}return!0}return e!=e&&n!=n},p=null,y="https://edge.api.flagsmith.com/api/v1/",m=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},S=function(){function t(t){var e=this;this.eventSource=null,this.getJSON=function(t,n,r){var i=e,a=i.environmentID,o=i.headers,s={method:n||"GET",body:r,headers:{"x-environment-key":"".concat(a)}};return n&&"GET"!==n&&(s.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(s.headers,o),f||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR."),f(t,s).then((function(r){return e.log("Fetch response: "+r.status+" "+(n||"GET")+0+t),r.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return r.status>=200&&r.status?e:Promise.reject(e)}))})).catch((function(t){throw console.error("Flagsmith: Fetch error: "+t),new Error("Flagsmith: Fetch error:"+t)}))},this.getFlags=function(t,n){var r=e,i=r.onChange,a=r.onError,o=r.identity,s=r.api,l=!1;e.log("Get Flags");var u=function(t){var n=t.flags,r=t.traits;o&&(e.withTraits=null);var a={},s={};r=r||[],(n=n||[]).forEach((function(t){a[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),r.forEach((function(t){s[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),e.oldFlags=h({},e.flags);var l=d(e.flags,a),u=d(e.traits,s);if(e.flags=a,e.traits=s,e.updateStorage(),e.datadogRum&&(Object.keys(e.flags).map((function(t){e.datadogRum.client.addFeatureFlagEvaluation?(e.datadogRum.client.addFeatureFlagEvaluation("flagsmith_value_"+t,e.getValue(t)),e.datadogRum.client.addFeatureFlagEvaluation("flagsmith_enabled_"+t,e.hasFeature(t))):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")})),e.datadogRum.trackTraits)){var c={};Object.keys(e.traits).map((function(t){c["flagsmith_trait_"+t]=e.getTrait(t)})),e.datadogRum.client.setUser(h(h({},e.datadogRum.client.getUser()),c))}if(e.dtrum){var g={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(e.flags).map((function(t){E(g,"flagsmith_value_"+t,e.getValue(t)),E(g,"flagsmith_enabled_"+t,e.hasFeature(t))})),Object.keys(e.traits).map((function(t){E(g,"flagsmith_trait_"+t,e.getTrait(t))})),e.log("Sending javaLongOrObject traits to dynatrace",g.javaLongOrObject),e.log("Sending date traits to dynatrace",g.date),e.log("Sending shortString traits to dynatrace",g.shortString),e.log("Sending javaDouble to dynatrace",g.javaDouble),e.dtrum.sendSessionProperties(g.javaLongOrObject,g.date,g.shortString,g.javaDouble)}e.trigger&&(e.log("trigger called"),e.trigger()),i&&i(e.oldFlags,{isFromServer:!0,flagsChanged:!l,traitsChanged:!u})};return o?Promise.all([e.withTraits?e.getJSON(s+"identities/","POST",JSON.stringify({identifier:o,traits:Object.keys(e.withTraits).map((function(t){return{trait_key:t,trait_value:e.withTraits[t]}}))})):e.getJSON(s+"identities/?identifier="+encodeURIComponent(o))]).then((function(n){e.withTraits=null,u(n[0]),t&&!l&&(l=!0,t())})).catch((function(t){var e=t.message;a&&a({message:e})})):Promise.all([e.getJSON(s+"flags/")]).then((function(e){u({flags:e[0],traits:void 0}),t&&!l&&(l=!0,t())})).catch((function(t){n&&!l&&(l=!0,n(t)),a&&a(t)}))},this.analyticsFlags=function(){var t=e.api;if(e.evaluationEvent&&e.evaluationEvent[e.environmentID])return e.evaluationEvent&&0!==Object.getOwnPropertyNames(e.evaluationEvent).length&&0!==Object.getOwnPropertyNames(e.evaluationEvent[e.environmentID]).length?e.getJSON(t+"analytics/flags/","POST",JSON.stringify(e.evaluationEvent[e.environmentID])).then((function(t){var n=e.getState();e.evaluationEvent||(e.evaluationEvent={}),e.evaluationEvent[e.environmentID]={},e.setState(h(h({},n),{evaluationEvent:e.evaluationEvent})),e.updateEventStorage()})).catch((function(t){e.log("Exception fetching evaluationEvent",t)})):void 0},this.datadogRum=null,this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.trigger=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t){if(e.enableAnalytics){if(!e.evaluationEvent)return;e.evaluationEvent[e.environmentID]||(e.evaluationEvent[e.environmentID]={}),void 0===e.evaluationEvent[e.environmentID][t]&&(e.evaluationEvent[e.environmentID][t]=0),e.evaluationEvent[e.environmentID][t]+=1}e.updateEventStorage()},this.getValue=function(t,n){var r=e.flags&&e.flags[t.toLowerCase().replace(/ /g,"_")],i=null;if(r&&(i=r.value),e.evaluateFlag(t),null==n?void 0:n.json)try{return null===i?(e.log("Tried to parse null flag as JSON: "+t),n.fallback):JSON.parse(i)}catch(t){return n.fallback}return i},this.getTrait=function(t){return e.traits&&e.traits[t.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return e.traits},this.setTrait=function(t,n){if(e.api){var r={};return r[t]=n,e.setTraits(r)}console.error(m("setTrait"))},this.setTraits=function(t){if(e.api){if(t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),e.withTraits=h(h({},e.withTraits||{}),t),e.identity)return e.initialised?e.getFlags():void 0;e.log("Set traits prior to identifying",e.withTraits)}else console.error(m("setTraits"))},this.hasFeature=function(t){var n=e.flags&&e.flags[t.toLowerCase().replace(/ /g,"_")],r=!1;return n&&n.enabled&&(r=!0),e.evaluateFlag(t),r},f=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:null===global||void 0===global?void 0:global.fetch,this.canUseStorage="undefined"!=typeof window||!!t.browserlessStorage,this.log("Constructing flagsmith instance "+t),t.eventSource&&(v=t.eventSource),t.AsyncStorage&&(p=t.AsyncStorage)}return t.prototype.init=function(t){var e=this,n=t.environmentID,r=t.api,i=void 0===r?y:r,a=t.headers,o=t.onChange,s=t.cacheFlags,l=t.datadogRum,u=t.onError,c=t.defaultFlags,g=t.fetch,d=t.preventFetch,m=t.enableLogs,S=t.enableDynatrace,_=t.enableAnalytics,E=t.realtime,b=t.eventSourceUrl,I=void 0===b?"https://realtime.flagsmith.com/":b,O=t.AsyncStorage,w=t.identity,F=t.traits,T=t._trigger,C=t.state,j=t.cacheOptions,A=t.angularHttpClient;return new Promise((function(t,r){if(e.environmentID=n,e.api=i,e.headers=a,e.getFlagInterval=null,e.analyticsInterval=null,e.onChange=o,e.trigger=T||e.trigger,e.onError=u,e.identity=w,e.withTraits=F,e.enableLogs=m||!1,e.cacheOptions=j?{skipAPI:!!j.skipAPI,ttl:j.ttl||0}:e.cacheOptions,!e.cacheOptions.ttl&&e.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),g&&(f=g),e.enableAnalytics=_||!1,e.flags=Object.assign({},c)||{},e.initialised=!0,e.ticks=1e4,E&&"undefined"!=typeof window){var y=I+"sse/environments/"+n+"/stream";v?e.eventSource||(e.log("Creating event source with url "+y),e.eventSource=new v(y),e.eventSource.addEventListener("environment_updated",(function(t){e.log("Received eventsource message"),e.getFlags()}))):e.log("Error, EventSource is undefined")}if(e.log("Initialising with properties",{environmentID:n,api:i,headers:a,onChange:o,cacheFlags:s,onError:u,defaultFlags:c,preventFetch:d,enableLogs:m,enableAnalytics:_,AsyncStorage:p,identity:w,traits:F,_trigger:T,state:C,angularHttpClient:A},e),e.timer=e.enableLogs?(new Date).valueOf():null,O&&(p=O),e.cacheFlags=void 0!==p&&!!s,e.setState(C),!n)throw r("Please specify a environment id"),"Please specify a environment id";l&&(e.datadogRum=l),S&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):e.dtrum=dtrum),A&&(f=function(t,e){var n=e.headers,r=e.method,i=e.body;return new Promise((function(e){switch(r){case"GET":return A.get(t,{headers:n}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return A.post(t,i,{headers:n}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}))}}))}),p&&e.canUseStorage&&p.getItem("BULLET_TRAIN_EVENT").then((function(t){if(t)try{e.evaluationEvent=JSON.parse(t)}catch(t){e.evaluationEvent={}}else e.evaluationEvent={};return e.analyticsInterval=setInterval(e.analyticsFlags,e.ticks),!0})),e.enableAnalytics&&(e.analyticsInterval&&clearInterval(e.analyticsInterval),p&&e.canUseStorage&&p.getItem("BULLET_TRAIN_EVENT",(function(t,n){if(n){var r=JSON.parse(n);r[e.environmentID]&&(C=e.getState(),e.log("Retrieved events from cache",n),e.setState(h(h({},C),{evaluationEvent:r[e.environmentID]})))}return!0}))),s?p&&e.canUseStorage&&p.getItem("BULLET_TRAIN_DB",(function(n,i){if(i)try{var a=JSON.parse(i),o=!1;if(a&&a.api===e.api&&a.environmentID===e.environmentID){var s=!0;e.identity&&a.identity!==e.identity&&(e.log("Ignoring cache,  identity has changed from "+a.identity+" to "+e.identity),s=!1),e.cacheOptions.ttl&&(!a.ts||(new Date).valueOf()-a.ts>e.cacheOptions.ttl)&&a.ts&&(e.log("Ignoring cache, timestamp is too old ts:"+a.ts+" ttl: "+e.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-a.ts)+"ms"),s=!1),s&&(o=!0,e.setState(a),e.log("Retrieved flags from cache",a))}e.flags?(e.trigger&&(e.log("trigger called"),e.trigger()),e.onChange&&(e.log("onChange called"),e.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!e.traits})),e.oldFlags=e.flags,t(!0),e.cacheOptions.skipAPI&&o&&e.log("Skipping API, using cache"),d||e.cacheOptions.skipAPI&&o||e.getFlags()):d?t(!0):e.getFlags(t,r)}catch(t){e.log("Exception fetching cached logs",t)}else d?(c&&(e.trigger&&(e.log("trigger called"),e.trigger()),e.onChange&&(e.log("onChange called"),e.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!e.traits}))),t(!0)):e.getFlags(t,r);return!0})):d?(c&&(e.trigger&&(e.log("trigger called"),e.trigger()),e.onChange&&(e.log("onChange called"),e.onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!e.traits}))),t(!0)):e.getFlags(t,r)})).catch((function(t){e.log("Error during initialisation ",t),u&&u(t)}))},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,e){return this.identity=t,this.log("Identify: "+this.identity),e&&(this.withTraits=h(h({},this.withTraits||{}),e)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||y,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.evaluationEvent=t.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,g(["FLAGSMITH:",(new Date).valueOf()-(this.timer||0),"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),p.setItem("BULLET_TRAIN_DB",t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);this.log("Setting event storage",t),p.setItem("BULLET_TRAIN_EVENT",t)}},t.prototype.logout=function(){return this.identity=null,this.traits=null,this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},t.prototype.getSegments=function(){},t}();function _(t){var e=t.fetch;t.browserlessStorage;var n=t.AsyncStorage,r=t.eventSource;return new S({fetch:e,AsyncStorage:n,eventSource:r})}var E=function(t,e,n){var r="shortString",i=!0;"number"==typeof n&&(r="javaDouble",i=!1),t[r]=t[r]||{},t[r][e]=i?n+"":n},b=_({AsyncStorage:i,eventSource:c}),I=function(){return _({AsyncStorage:i,eventSource:c})};export{I as createFlagsmithInstance,b as default};
//# sourceMappingURL=isomorphic.js.map
